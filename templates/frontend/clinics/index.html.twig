{% extends 'layout_clinic.html.twig' %}

{% block meta_title %}Fluid Inventory Search{% endblock %}

{% block meta_decription %}
    <meta name="description" content="">
{% endblock %}

{% block stylesheets %}
    {{ parent() }}
{% endblock %}

{% block body %}
    <div class="hidden users-flash m-0 save-all-items" id="flash"></div>
    <div class="container-xl mt-2 mt-sm-5 mb-1 mb-sm-5" id="inventory_container">
        <div class="row">
            <div class="col-12" id="inventory">
                {{ response|raw }}
            </div>
        </div>
    </div>
    <div class="container-xl mt-5 mb-1 mb-sm-5 d-none" id="lists_container"></div>
    <div class="container">
        <div class="d-none row" id="back_btn"></div>
        <div class="row ms-1 me-1 ms-md-0 me-md-0 mb-5">
            <div id="basket_container"></div>
        </div>
        <div class="hidden mt-3" id="paginator"></div>
    </div>

    <div class="overlay"></div>
    <div class="spanner">
        <div class="loader"></div>
        <p class="text-light fw-bold" style="font-size: 36px;">Loading...</p>
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        $('#btn_basket').attr('data-basket-id', {{ basket_id }});

        $(window).on('load', function(e)
        {
            let uri = window.location.pathname;
            let is_search = uri.match('/clinics/inventory');
            history.pushState(null, null, window.location.href);
            history.back();
            window.onpopstate = () => history.forward();

            if($.session.get('search_key') !== '' && $.session.get('search_key') !== 'undefined' && is_search != null)
            {
                let pageNo = 1;
                let keyword = $.session.get('search_key');

                $.ajax({
                    async: "true",
                    url: "{{ path('search_inventory') }}",
                    type: 'POST',
                    data: {
                        'keyword': keyword,
                        'page-no': pageNo
                    },
                    success: function (response)
                    {
                        if(window.location.pathname == '/clinics/inventory')
                        {
                            $('#search_field').val(keyword);
                            $('#inventory').empty().append(response.html);
                            $('.container').removeClass('mt-5').addClass('mt-5');
                            document.title = 'Fluid';
                            window.history.pushState({
                                "html": response.html,
                                "pageTitle": 'Fluid'
                            }, "", '{{ app.request.baseUrl }}/clinics/inventory');

                            $.session.set('search_key', keyword);

                            $(response.productIds).each(function (index, value)
                            {
                                let productId = value;

                                $.ajax({
                                    async: "true",
                                    url: "{{ path('product_get_distributors') }}",
                                    type: 'POST',
                                    dataType: 'json',
                                    data: {
                                        'product-id': productId,
                                    },
                                    complete: function (e)
                                    {
                                        if (e.status === 500)
                                        {
                                            window.location.href = '{{ path('clinic_error_500') }}';
                                        }
                                    },
                                    success: function (response)
                                    {
                                        $('#search_result_distributors_'+ productId).empty().append(response.html);
                                        $('.from_'+ productId).empty().append(response.from);
                                        popOver();
                                    }
                                });
                            });
                        }
                    }
                });
            }
        });

        $(document).ready(function ()
        {
            let uri = window.location.pathname;
            let isOrderDetail = uri.match('/clinics/order/[0-9]+');
            let isOrderList = uri.match('/clinics/orders/[0-9]+');
            let isBasket = uri.match('/clinics/basket');
            let isSavedBaskets = uri.match('/clinics/saved/baskets');
            let isAccountSettings = uri.match('/clinics/account');
            let isUsers = uri.match('/clinics/users');
            let isAddresses = uri.match('/clinics/addresses');
            let isCommunicationMethod = uri.match('/clinics/communication-methods');
            let isList = uri.match('/clinics/inventory/list/[0-9]+');
            let isEditList = uri.match('/clinics/inventory/manage/list/[0-9]+');
            let isAnalytics = uri.match('/clinics/analytics');
            let isManageLists = uri.match('/clinics/inventory/lists');
            let isManageInventory = uri.match('/clinics/manage-inventory');
            let orderid = '{{app.request.get('order_id')}}';
            let distributorid = '{{app.request.get('distributor_id')}}';
            let iti = '';
            let isoCode = '';
            let intlCode = '';
            let searchArray = [];
            let categoryArray = [];
            let manufacturerArray = [];
            let selectedManufacturerArray = [];
            let distributorArray = [];
            let selectedDistributorArray = [];
            let favourite = false;
            let inStock = false;
            let clinicId = {{ clinic_id|default(0) }};

            $('#btn_map').hide();

            $(document).on('click', '.dropdown-item, #btn_basket', function ()
            {
                $('#main_nav').slideUp();
                $('#account_menu').slideUp();
            });

            $(document).click(function (event) {

                /// If *navbar-collapse* is not among targets of event
                if (!$(event.target).is('.navbar-collapse *')) {

                    /// Collapse every *navbar-collapse*
                    $('.navbar-collapse').collapse('hide');

                }
            });

            function isLoading(status)
            {
                if(status)
                {
                    $("div.spanner").addClass("show");
                    $("div.overlay").addClass("show");

                }
                else
                {
                    $("div.spanner").removeClass("show");
                    $("div.overlay").removeClass("show");
                }
            }

            {# Prevent loading overlay on multiple clicks #}
            $(document).on('click','.account-dropdown-toggle', function (e)
            {
                e.preventDefault();
                isLoading(false);
            });

            {# Redirect to company info if not approved #}
            if(isOrderList != null)
            {
                window.location.href = '{{ app.request.schemeAndHttpHost }}/clinics/account';
            }

            {# Get correct content on refresh #}
            {# Analytics #}
            if(isAnalytics != null)
            {
                getAnalytics();
            }

            {# Account & Settings #}
            if(isAccountSettings != null)
            {
                getAccountSettings();
            }

            {# Users #}
            if(isUsers != null)
            {
                getUsers(1);
            }

            {# Addresses #}
            if(isAddresses != null)
            {
                getAddresses(1);
            }

            {# Communication Methods #}
            if(isCommunicationMethod != null)
            {
                getCommunicationMethods();
            }

            {# Order List #}
            if('{{ clinicOrderList }}' == 1)
            {
                let clinic_id = '{{ app.request.get('clinic_id') }}';

                getOrdersList(clinic_id, 1,'','','');
            }

            {# Order Details #}
            if(isOrderDetail != null && orderid > 0 && distributorid > 0)
            {
                getOrderDetails(orderid, distributorid, '{{clinic_id}}');
            }

            {# Baskets #}
            if(isBasket != null)
            {
                let basket_id = '{{ app.request.get('basket_id') }}';

                getBasket(basket_id, true, '');
            }

            {# Saved Baskets #}
            if(isSavedBaskets != null)
            {
                getSavedBaskets();
            }

            {# Shopping list #}
            if(isList != null)
            {
                getSearchResults(1, '', true, '{{ app.request.get('list_id') }}', [], '');
            }

            if(isEditList != null)
            {
                getSingleShoppingList('{{ app.request.get('list_id') }}');
            }

            {# Manage Order Lists #}
            if(isManageLists != null)
            {
                let keyword = '';

                getShoppingLists(keyword);
            }

            {# Manage Inventory #}
            if(isManageInventory != null)
            {
                getManageInventory();
            }

            {# Inventory Search #}
            let page_no = 0;
            let form_data = '';
            let get_messages = '';

            {# Categories #}
            $(document).on('click', '.category-select', function(e)
            {
                e.preventDefault();

                let categoryId = $(this).attr('data-category-id');
                let level = $(this).attr('data-level');
                categoryArray = [];

                categoryArray.push({'level':level, 'categoryId': categoryId});

                getSearchArray();
                getSearchResults(1, '', false, 0, searchArray, '');
                resetFilterBtn();
            });

            {# Distributors #}
            $(document).on('click', '.distributor-select', function(e)
            {
                e.preventDefault();

                let distributorId = $(this).attr('data-distributor-id');
                let checkbox = $(this).find('input:first-child');

                if(checkbox.is(':checked'))
                {
                    checkbox.attr('checked', false);
                    selectedDistributorArray = $.grep(selectedDistributorArray, function(value)
                    {
                        return value != distributorId;
                    });
                }
                else
                {
                    checkbox.attr('checked', true);
                    selectedDistributorArray.push(distributorId)
                }

                getSearchArray();
                getSearchResults(1, '', false, 0, searchArray, '');
                resetFilterBtn();
            });

            {# Manufacturers #}
            $(document).on('click', '.manufacturer-select', function(e)
            {
                e.preventDefault();

                let manufacturerId = $(this).attr('data-manufacturer-id');
                let checkbox = $(this).find('input:first-child');

                if(checkbox.is(':checked'))
                {
                    checkbox.attr('checked', false);
                    selectedManufacturerArray = $.grep(selectedManufacturerArray, function(value)
                    {
                        return value != manufacturerId;
                    });
                }
                else
                {
                    checkbox.attr('checked', true);
                    selectedManufacturerArray.push(manufacturerId)
                }

                getSearchArray();
                getSearchResults(1, '', false, 0, searchArray, '');
                resetFilterBtn();
            });

            {# Favourites #}
            $(document).on('click', '.favourite-select', function (e)
            {
                e.preventDefault();

                let checkbox = $(this).find('input');

                if(checkbox.is(':checked'))
                {
                    checkbox.attr('checked', false);
                    favourite = false;

                }
                else
                {
                    checkbox.attr('checked', true);
                    favourite = true;
                }

                getSearchArray();
                getSearchResults(1, '', false, 0, searchArray, '');
                resetFilterBtn();
            });

            {# In Stock #}
            $(document).on('click', '.in-stock-select', function (e)
            {
                e.preventDefault();

                let checkbox = $(this).find('input');

                if(checkbox.is(':checked'))
                {
                    checkbox.attr('checked', false);
                    inStock = false;
                }
                else
                {
                    checkbox.attr('checked', true);
                    inStock = true;
                }

                getSearchArray();
                getSearchResults(1, '', false, 0, searchArray, '');
                resetFilterBtn();
            });

            {# Reset Filters #}
            $(document).on('click', '#filter_reset_btn', function(e)
            {
                e.preventDefault();

                let pageNo = 1;
                let keyword = $('#search_field').val();

                $.ajax({
                    async: "true",
                    url: "{{ path('search_inventory') }}",
                    type: 'POST',
                    data: {
                        'keyword': keyword,
                        'page-no': pageNo
                    },
                    beforeSend: function ()
                    {
                        isLoading(true);
                    },
                    complete: function(e)
                    {
                        if(e.status === 500)
                        {
                            window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                    success: function (response)
                    {
                        if(window.location.pathname == '/clinics/inventory')
                        {
                            $('#search_field').val(keyword);
                            $('#inventory').empty().append(response.html);
                            $('.container').removeClass('mt-5').addClass('mt-5');
                            $('#dd_categories').empty().append(response.category_list);
                            $('#dd_distributors').empty().append(response.distributors_list);
                            $('#dd_manufacturers').empty().append(response.manufacturers_list);
                            $('#filter_favourite').attr('checked', false);
                            $('#filter_in_stock').attr('checked', false);
                            $('#filter_reset_btn').remove();
                            isLoading(false);
                            searchArray = [];
                            categoryArray = [];
                            selectedDistributorArray = [];
                            selectedManufacturerArray = [];
                            favourite = false;
                            inStock = false;
                            document.title = 'Fluid';
                            window.history.pushState({
                                "html": response.html,
                                "pageTitle": 'Fluid'
                            }, "", '{{ app.request.baseUrl }}/clinics/inventory');
                            $.session.set('search_key', keyword);
                        }
                    }
                });
            });

            function getSearchArray()
            {
                searchArray = [];

                searchArray.push({
                    category: categoryArray,
                    selectedDistributors: selectedDistributorArray,
                    distributors: distributorArray,
                    selectedManufacturers: selectedManufacturerArray,
                    manufacturers: manufacturerArray,
                    favourite: favourite,
                    clinicId: clinicId,
                    inStock: inStock,
                });

                return searchArray;
            }

            function unique(list)
            {
                let result = [];
                $.each(list, function(i, e)
                {
                    if ($.inArray(e, result) == -1) result.push(e);
                });
                return result;
            }

            $(document).on('click','.page-link',function ()
            {
                page_no = $(this).data('page-id');
            });
            $(document).on('click','#search_btn',function ()
            {
                page_no = 1;
            });
            $(document).on('click','.view-list',function (e)
            {
                e.preventDefault();
                $.session.set('listSearchKey', $('#search_field').val());
                $('#search_field').val('');
            });

            function getSearchResults(pageId, object, shippingList = false, listId = 0, searchArray = [], elementId = '')
            {
                let keyword = $.session.get('search_key') ? $.session.get('search_key') : 'canine';
                let listKeyword = $.session.get('search_key') ? $.session.get('search_key') : 'canine';
                let keywordField = false;
                let pageNo = pageId;
                let className = '';
                let uri = window.location.pathname;
                let isListUri = uri.match('/clinics/inventory/lists');

                $('#paginator').empty().hide();

                if(object != 'undefined' && object != '')
                {
                    className = object.className.substring(10);
                }

                if($('#search_field').val() != '' || $('#search_field').val() != 'undefined')
                {
                    keyword = $('#search_field').val();
                }

                if((object != 'undefined' && object != '') && object.className.substring(23,42) == 'list-back-to-search')
                {
                    keyword = $(object).data('keyword-string');
                    keywordField = true;
                }

                if(className == 'view-list' || isListUri != null)
                {
                    listKeyword = $(object).data('keyword-string');
                }

                if($(object).data('list-id') != '' && $(object).data('list-id') != 'undefined' && listId == 0)
                {
                    listId = $(object).data('list-id');
                }

                $.ajax({
                    async: "true",
                    url: "{{ path('search_inventory') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        'keyword': keyword,
                        'list-keyword': listKeyword,
                        'list-id': listId,
                        'page-no': pageNo,
                        'page-id': pageId,
                        'search-array': searchArray,
                    },
                    beforeSend: function ()
                    {
                        isLoading(true);

                        $('#main_nav').slideUp(700);
                        window.scrollTo(0, 0);
                    },
                    complete: function(e)
                    {
                        if(e.status === 500)
                        {
                            //window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                    success: function (response)
                    {
                        $('#inventory').empty().append(response.html).show();
                        window.scrollTo(0,0);
                        $('#basket_container').empty().hide();
                        $('#inventory_container').show();
                        $('.has-megamenu').show(700);
                        $('#favourite_label').empty().append('('+ response.favouriteCount +') Favourite Items');
                        $('#in_stock_label').empty().append('('+ response.inStockCount +') In Stock');
                        $('.manage-lists').attr('data-keyword-string', keyword);

                        $(response.productIds).each(function (index, value)
                        {
                            let productId = value;

                            $.ajax({
                                async: "true",
                                url: "{{ path('product_get_distributors') }}",
                                type: 'POST',
                                dataType: 'json',
                                data: {
                                    'product-id': productId,
                                },
                                complete: function (e)
                                {
                                    if (e.status === 500)
                                    {
                                        window.location.href = '{{ path('clinic_error_500') }}';
                                    }
                                },
                                success: function (response)
                                {
                                    $('.basket-id').val($('#btn_basket').attr('data-basket-id'));
                                    $('#search_result_distributors_'+ productId).empty().append(response.html);
                                    $('.from_'+ productId).empty().append(response.from);
                                    popOver();
                                }
                            });
                        });

                        // Category Levels
                        if(response.level == 3)
                        {
                            let categoryId = $.map(categoryArray, function(cat) {
                                return cat.categoryId[0];
                            });

                            $('#dd_categories').find('.category-select').each(function ()
                            {
                                $(this).find('label').css('font-weight', '');
                                $('#megamenu').hide(700);
                            });

                            $('*[data-category-id="'+ categoryId +'"]').find('label').css('font-weight', 'bold');
                        }
                        else
                        {
                            $('#dd_categories').empty().append(response.categoryList);
                            $('#dd_distributors').empty().append(response.distributorsList);
                            $('#dd_manufacturers').empty().append(response.manufacturersList);
                        }

                        if(elementId == 'search_btn')
                        {
                            {# Manufacrurer Filter List #}
                            manufacturerArray = [];

                            $('.manufacturer-checkbox').each(function ()
                            {
                                let manufacturer = $(this).next().text().trim().substring(4);
                                let manufacturerId = $(this).val();
                                let itemCount = $(this).next().text().trim().substring(1,2);

                                manufacturerArray.push({
                                    'id': manufacturerId,
                                    'name': manufacturer,
                                    'count': itemCount,
                                });
                            });

                            {# Distributor Filter List #}
                            distributorArray = [];

                            $('.distributor-checkbox').each(function ()
                            {
                                let distributor = $(this).next().text().trim().substring(4);
                                let distributorId = $(this).val();
                                let itemCount = $(this).next().text().trim().substring(1,2);

                                distributorArray.push({
                                    'id': distributorId,
                                    'name': distributor,
                                    'count': itemCount,
                                });
                            });
                        }

                        if(className == 'view-list' || listId > 0 || isListUri != null)
                        {
                            if(listKeyword == '' || listKeyword == 'undefined')
                            {
                                listKeyword = $.session.get('search_key');
                            }

                            getListBackButton(listKeyword, listId);
                            window.history.pushState(null, "Fluid", '/clinics/inventory/list/' + listId);
                        }
                        else
                        {
                            window.history.pushState(null, "Fluid", '/clinics/inventory');
                        }

                        if(keywordField)
                        {
                            $('#search_field').val(keyword)
                        }

                        isLoading(false);

                        if(keyword != '' || keyword != 'undefined')
                        {
                            $.session.set('search_key', keyword);
                        }

                        let popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
                        let popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
                            return new bootstrap.Popover(popoverTriggerEl);
                        });
                    }
                });
            }

            $(document).on('click','#search_btn, .page-link, .view-list, .list-back-to-search',function (e)
            {
                e.preventDefault();
                clearInterval(get_messages);
                let object = this;
                let page_id = $(this).data('page-id');
                let elementId = $(this).attr('id');

                getSearchResults(page_id, object, false, 0, [], elementId);
            });
            $(document).on('click', '.favourite', function (e)
            {
                e.preventDefault();

                let productId = $(this).data("product-id");
                let listId = $(this).data("list-id");
                let favourite = $(this).attr('data-favourite');

                if(favourite == 'false')
                {
                    $.ajax({
                        async: "true",
                        url: "{{ path('inventory_get_list_modal') }}",
                        type: 'POST',
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: {
                            'product-id': productId,
                            'list-id': listId

                        },
                        success: function (response)
                        {
                            $('#modal_list_distributors').remove();
                            $('#inventory_container').append(response);
                            $('#modal_list_distributors').modal('toggle');
                            $('#save_list_distributor').attr('data-favourite','true');
                            $('body').css('overflow', '');
                        }
                    });

                }
                else
                {

                    let distributorId = $(this).data('distributor-id');

                    $.ajax({
                        async: "true",
                        url: "{{ path('inventory_manage_list') }}",
                        type: 'POST',
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: {
                            'product-id': productId,
                            'list-id': listId,
                            'distributor-id': distributorId,
                            'favourite': favourite,
                            delete: true,
                            'return': '',
                        },
                        success: function (response)
                        {
                            $('#favourite_'+ productId).removeClass('text-danger').addClass('icon-unchecked')
                                .attr('data-favourite', false).removeAttr('data-distributor-id');
                        }
                    });
                }
            });
            $(document).on('click', '.open-carousel', function (e)
            {
                e.preventDefault();

                let productId = $(this).data('product-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('product_gallery') }}",
                    type: 'POST',
                    data: {
                        productId: productId
                    },
                    complete: function(e)
                    {
                        if(e.status === 500)
                        {
                            window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                    success: function (response)
                    {
                        $('#modal_body_'+ productId).empty().append(response);
                        $('#modal_gallery_'+ productId).modal('toggle');
                    }
                });
            });
            $(document).on('click', '.carousel-close', function ()
            {
                let carouselId = $(this).data('carousel-id');

                $('#modal_gallery_'+ carouselId).modal('toggle');
            });
            $(document).on('click','.back-to-search', function (e)
            {
                e.preventDefault();

                $('.review_panel').hide();
                $('.search-panels-container').hide();
                $('#basket_container').empty().hide();
                $('#back_btn').addClass('d-none').removeClass('d-flex');
                $('#inventory').show();
                $('#inventory_container').show();
            });
            $(document).on('click', '.close-filter', function ()
            {
                $('#megamenu').slideUp(700);
            });
            function getBackButton(){

                // let button = '<div class="col-12">';
                // button += '<button class="btn btn-sm btn-primary back-to-search mb-3 w-sm-100 w-auto">';
                // button += '<i class="fa-solid fa-circle-chevron-left me-3"></i>Back To Search</button>';
                // button += '</div>';

                //$('#back_btn').empty().append(button).removeClass('d-none').addClass('d-flex');
            }
            function getListBackButton(keyword, list_id)
            {
                let button = '<div class="row">';
                button += '<div class="col-12">';
                button += '<button data-keyword-string="'+ keyword +'" data-keyword-string="'+ list_id +'" class="btn btn-sm btn-primary list-back-to-search mb-3 w-sm-100 w-auto">';
                button += '<i class="fa-solid fa-circle-chevron-left me-3"></i>Back To Search</button>';
                button += '</div>';
                button += '</div>';

                $('#inventory').prepend(button);
            }
            {# End Inventory Search #}

            {# Basket #}
            {# Add To Basket #}
            $(document).on('submit', 'form[name="form_add_to_basket"]', function (e)
            {
                e.preventDefault();

                let data = new FormData(this);
                let productId = data.get('product_id');
                let distributorId = data.get('distributor_id');
                let qty = data.get('qty');
                let qtyError = $('#error_qty_'+ productId +'_'+ distributorId);
                let isValid = true;

                qtyError.hide()

                if(qty == '' || qty == 'undefined')
                {
                    qtyError.show();
                    isValid = false;
                }

                if(isValid)
                {
                    $.ajax({
                        async: "true",
                        url: "{{ path('inventory_add_to_basket') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        complete: function(e)
                        {
                            if(e.status === 500)
                            {
                               //window.location.href = '{{ path('clinic_error_500') }}';
                            }
                        },
                        success: function (response)
                        {
                            if(response.error.length == 0)
                            {
                                getFlash(response.message)
                                $('#modal_add_to_basket_' + response.product_id + '_' + response.distributor_id).modal('toggle').modal('hide');
                                $('.modal-backdrop').removeClass('modal-backdrop');
                                $('.fade').removeClass('fade');
                                $('.modal-basket-qty').val(1);

                            }
                            else
                            {
                                $('#error_stock_'+ response.product_id +'_'+ response.distributor_id).show().empty().append(response.error);
                            }
                        }
                    });
                }
            });
            {# End Add To Basket #}

            {# Update Basket #}
            function getBasket(basketId, redirect, savedBasketResponse)
            {
                hidePaginator();

                $.ajax({
                    async: "true",
                    url: "{{ path('get_basket') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        basket_id: basketId,
                        permissions: '{{ permissions|json_encode }}'
                    },
                    beforeSend: function ()
                    {
                        isLoading(true);
                    },
                    complete: function(e)
                    {
                        if(e.status === 500)
                        {
                            //window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                    success: function (response)
                    {
                        $('#back_btn').hide();
                        $('#inventory_container').hide();
                        $('#basket_container').empty().append(response).fadeIn(500);
                        window.scrollTo(0,0);
                        $('#return_to_search').attr('data-basket-id', $('#btn_basket').attr('data-basket-id'))
                        $("#basket_container").addClass('col-container');
                        $('#saved_items_container').hide();
                        isLoading(false);
                        clearInterval(get_messages);
                        $('.back-to-search').remove();

                        if($(window).width() < 992)
                        {
                            $('#basket_container').css({ overflow:"hidden" });
                        }

                        if(redirect)
                        {
                            window.history.pushState(null, "Fluid", '/clinics/basket/' + basketId);

                        }
                        else
                        {
                            $('#basket_items').empty().append(savedBasketResponse);

                            $('.saved-basket-panel').each(function ()
                            {
                                $('.saved-basket-panel').hide();
                            });
                        }

                        popOver();
                    }
                });
            }
            function getFlash(flash)
            {
                $('#flash').addClass('alert-success').removeClass('alert-danger').addClass('alert').addClass('text-center');
                $('#flash').removeClass('users-flash').addClass('users-flash').empty().append(flash).removeClass('hidden');

                setTimeout(function()
                {
                    $('#flash').removeClass('alert-success').removeClass('alert').removeClass('text-center');
                    $('#flash').removeClass('users-flash').empty().addClass('hidden');
                }, 5000);
            }
            function getSavedBaskets(redirect)
            {
                $.ajax({
                    async: "true",
                    url: "{{ path('get_saved_baskets') }}",
                    type: 'GET',
                    dataType: 'json',
                    beforeSend: function ()
                    {
                        isLoading(true);
                    },
                    complete: function(e)
                    {
                        if(e.status === 500)
                        {
                            window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                    success: function (response)
                    {
                        isLoading(false);
                        getBasket($('#btn_basket').data('basket-id'), false, response);

                        window.history.pushState(null, "Fluid", '/clinics/saved/baskets');
                    }
                });
            }
            let basketQty = '';
            $(document).on('change', '.basket-qty, .modal-basket-qty', function ()
            {
                basketQty = $(this).val();
            });
            $(document).on('change', '.basket-qty', function ()
            {
                let itemId = $(this).data('basket-item-id');
                let qty = $(this).val();
                let isValid = true;

                if(isValid)
                {
                    $(this).val(1);

                    $.ajax({
                        async: "true",
                        url: "{{ path('inventory_update_basket') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            'item-id': itemId,
                            qty: qty
                        },
                        beforeSend: function ()
                        {
                            isLoading(true);
                        },
                        success: function (response)
                        {
                            if(response.error.length == 0)
                            {
                                $('#inventory_container').fadeOut(900);

                                let basketId = response.basketId;

                                getBasket(basketId, true, '');
                            }
                            else
                            {
                                isLoading(false);
                                $('#stock_count_error_'+ response.itemId).show().empty().append(response.error);
                            }
                        }
                    });
                }
            });
            $(document).on('change', '.modal-basket-qty', function ()
            {
                basketQty = $(this).val();
            });
            $(document).on('click', '.remove-item', function (e)
            {
                e.preventDefault();

                let itemId = $(this).data('item-id');

                if(itemId > 0)
                {
                    $.ajax({
                        async: "true",
                        url: "{{ path('inventory_remove_basket_item') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            'item-id': itemId
                        },
                        beforeSend: function ()
                        {
                            isLoading(true);
                        },
                        complete: function(e)
                        {
                            if(e.status === 500)
                            {
                                window.location.href = '{{ path('clinic_error_500') }}';
                            }
                        },
                        success: function (response)
                        {
                            $('#inventory_container').hide();

                            let basketId = response.basketId;

                            getBasket(basketId, true, '');
                        }
                    });
                }
            });
            $(document).on('click', '.clear-basket', function (e)
            {
                e.preventDefault();

                let basketId = $(this).attr('data-basket-id');

                if(basketId > 0)
                {
                    $.ajax({
                        async: "true",
                        url: "{{ path('inventory_clear_basket') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            'basket-id': basketId
                        },
                        beforeSend: function ()
                        {
                            isLoading(true);
                        },
                        success: function (response)
                        {
                            $('#inventory_container').hide();

                            let basketId = response.basketId;
                            
                            getBasket(basketId, true, '');
                        }
                    });
                }
            });
            $(document).on('click', '.refresh-basket', function (e)
            {
                e.preventDefault();

                let basketId = $(this).data('basket-id');

                if(basketId > 0)
                {
                    let flash = '<b><i class="fas fa-check-circle"></i> Basket Refreshed.<div class="flash-close"><i class="fa-solid fa-xmark"></i></div>';

                    getBasket(basketId, true, '');
                    getFlash(flash);
                }
            });
            $(document).on('click', '#print_basket', function(e)
            {
                $('.basket-qty').each(function ()
                {
                    $(this).replaceWith($(this).val())
                });

                $('#btn_checkout').hide();

                let basket = $('#basket_items').html();
                let htm = '<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><title>Fluid Commerce</title>';
                htm += '<link rel="stylesheet" media="all" href="{{ asset('css/bootstrap.min.css') }}"><link rel="stylesheet" media="all" href="{{ asset('css/style.min.css') }}">';
                htm += '<style type="text/css" media="print">@page { size: landscape; }</style>';
                htm += '<link rel="stylesheet" href="/css/fontawesome/css/all.min.css"></head><body><div class="container-fluid">'+ basket;
                htm += '</container></body></html>';

                let w = window.open( '', "Customer Listing", "menubar=0,location=0,height=670,width=700" );
                w.document.write(htm);

                setTimeout(function(){w.print();w.close();},1000);

            });
            $(document).on('click', '.save-item', function(e)
            {
                e.preventDefault();

                let productId = $(this).data('product-id');
                let distributorId = $(this).data('distributor-id');
                let itemId = $(this).data('item-id');

                if(distributorId > 0 && productId > 0) {

                    $.ajax({
                        async: "true",
                        url: "{{ path('save_item') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            'product-id': productId,
                            'distributor-id': distributorId,
                            'item-id': itemId
                        },
                        beforeSend: function ()
                        {
                            isLoading(true);
                        },
                        complete: function(e)
                        {
                            if(e.status === 500){
                                window.location.href = '{{ path('clinic_error_500') }}';
                            }
                        },
                        success: function (response)
                        {
                            let basketId = response.basketId;
                            let flash = response.message;

                            getBasket(basketId, true, '');
                            getFlash(flash);
                        }
                    });
                }
            });
            $(document).on('click', '.restore-item', function(e)
            {
                e.preventDefault();

                let productId = $(this).data('product-id');
                let distributorId = $(this).data('distributor-id');
                let itemId = $(this).data('item-id');
                let basketId = $(this).data('basket-id');

                if(distributorId > 0 && productId > 0) {

                    $.ajax({
                        async: "true",
                        url: "{{ path('restore_item') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            'product-id': productId,
                            'distributor-id': distributorId,
                            'item-id': itemId,
                            'basket-id': basketId
                        },
                        beforeSend: function ()
                        {
                            isLoading(true);
                        },
                        complete: function(e)
                        {
                            if(e.status === 500)
                            {
                                window.location.href = '{{ path('clinic_error_500') }}';
                            }
                        },
                        success: function (response)
                        {
                            let basketId = response.basketId;
                            let flash = response.message;

                            getBasket(basketId, true, '');
                            getFlash(flash);
                        }
                    });
                }
            });
            $(document).on('click', '.remove-saved-item', function(e)
            {
                e.preventDefault();

                let itemId = $(this).data('item-id');
                let productRow = $(this).closest('.saved-item-row');

                if(itemId > 0)
                {
                    $.ajax({
                        async: "true",
                        url: "{{ path('remove_saved_item') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            'item-id': itemId
                        },
                        beforeSend: function (){
                            isLoading(true);
                        },
                        complete: function(e)
                        {
                            if(e.status === 500)
                            {
                                window.location.href = '{{ path('clinic_error_500') }}';
                            }
                        },
                        success: function (response)
                        {
                            productRow.remove();
                            getFlash(response.message);
                            isLoading(false);
                        }
                    });
                }
            });
            $(document).on('click', '.save-all-items', function(e)
            {
                e.preventDefault();

                let basketId = $(this).data('basket-id');

                if(basketId > 0)
                {
                    $.ajax({
                        async: "true",
                        url: "{{ path('save_all_items') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            'basket-id': basketId
                        },
                        beforeSend: function ()
                        {
                            isLoading(true);
                        },
                        success: function (response)
                        {
                            let basketId = response.basketId;
                            let flash = response.message;

                            getBasket(basketId, true, '');
                            getFlash(flash);
                        }
                    });
                }
            });
            $(document).on('click', '#saved_items_link', function (e)
            {
                e.preventDefault();

                if($('#saved_items_container:visible').length)
                {
                    $('#saved_items_container').hide(700);
                    $('#saved_items').css({'position':'absolute', 'right': 0, 'left':12});
                }
                else
                {
                    $('#saved_items_container').show(700);
                    $('#saved_items').css({'position':'relative', 'right': '', 'left':''});
                    $(this).closest('.col-12').removeClass('border-bottom');
                }
            });
            $(document).on('submit', 'form[name="form_save_basket"]', function (e)
            {
                e.preventDefault();

                let btn = $(this).find("button[type=submit]:focus" ).html();
                let clear = 0;

                if(btn == 'SAVE AND CLEAR')
                {
                    clear = 1;
                }

                $("<input />").attr("type", "hidden").attr("name", "clear").attr("value", clear).appendTo("#form_save_basket");

                let data = new FormData(this);
                let basketName = $('#basket_name').val();
                let errorBasketName = $('#error_basket_name');
                let isValid = true;

                errorBasketName.hide();

                if(basketName == '' || basketName == 'undefined')
                {
                    errorBasketName.show();
                    isValid = false;
                }

                if(isValid)
                {
                    $.ajax({
                        async: "true",
                        url: "{{ path('save_basket') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        success: function (response)
                        {
                            getFlash(response.message);
                            $('#modal_save_basket').modal('toggle').modal('hide');
                            $('.modal-backdrop').removeClass('modal-backdrop');
                            $('.fade').removeClass('fade');
                            getBasket(response.basketId, true, '');
                        }
                    });
                }
            });
            $(document).on('click', '#restore_all', function (e){

                e.preventDefault();

                let basket_id = $(this).data('basket-id');

                if(basket_id > 0) {

                    $.ajax({
                        async: "true",
                        url: "{{ path('restore_all_items') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            basket_id: basket_id
                        },
                        beforeSend: function () {
                            isLoading(true);
                        },
                        complete: function(e, xhr, settings){
                            if(e.status === 500){
                                window.location.href = '{{ path('clinic_error_500') }}';
                            }
                        },
                        success: function (response) {

                            let basket_id = response.basket_id;
                            let flash = response.message;

                            getBasket(basket_id, true, '');
                            getFlash(flash);
                        }
                    });
                }
            });
            $(document).on('click', '.saved_baskets_link', function (e){

                e.preventDefault();
                getSavedBaskets();

            });
            $(document).on('click', '.basket-edit', function (e){

                e.preventDefault();

                let basket_id = $(this).data('basket-id');

                $('#basket_name_string_'+ basket_id).hide();
                $('#basket_name_input_'+ basket_id).show();
                $(this).replaceWith('<a href="" class="update-saved-basket" id="update_saved_basket_'+ basket_id +'" data-basket-id="'+ basket_id +'"><i class="fa-solid fa-floppy-disk float-end me-3"></i></a>');
                $('#saved_basket_first_'+ basket_id).removeClass('saved-basket-link');
            });
            $(document).on('click', '.update-saved-basket', function (e){

                e.preventDefault();

                let basket_id = $(this).data('basket-id');
                let basket_name = $('#basket_name_'+ basket_id).val();

                $.ajax({
                    async: "true",
                    url: "{{ path('update_saved_baskets') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        basket_id:basket_id,
                        basket_name:basket_name
                    },
                    beforeSend: function () {
                        isLoading(true);
                    },
                    success: function (response) {

                        isLoading(false);
                        $('#basket_name_string_'+ basket_id).empty().append(basket_name).show();
                        $('#basket_name_input_'+ basket_id).hide();
                        $('#update_saved_basket_'+ basket_id).replaceWith('<a href="" class="basket-edit" data-basket-id="'+ basket_id +'"><i class="fa-solid fa-pencil float-end me-3"></i></a>');
                        $('#basket_left_col').empty().append(response);
                        $('#saved_basket_first_'+ basket_id).addClass('saved-basket-link');
                    }
                });
            });
            $(document).on('click', '.saved-basket-link', function (e){

                e.preventDefault();

                let basket_id = $(this).data('basket-id');
                $('.saved-basket-link').removeClass('bg-secondary');
                $('.saved-basket-panel').hide(700);

                $.ajax({
                    async: "true",
                    url: "{{ path('get_saved_basket_details') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        basket_id:basket_id
                    },
                    beforeSend: function () {
                        isLoading(true);
                    },
                    success: function (response) {

                        $('#saved_basket_panel_'+ basket_id).empty().append(response);
                        isLoading(false);

                        $('.saved_basket_header').removeClass('bg-secondary');

                        if($('#saved_basket_panel_'+ basket_id +':visible').length) {

                            $('#saved_basket_panel_' + basket_id).hide(700);


                        } else {

                            $('#saved_basket_panel_' + basket_id).show(700);
                            $('#saved_basket_header_'+ basket_id).addClass('bg-secondary');
                        }
                    }
                });
            });
            $(document).on('click', '.basket-delete', function (e){

                e.preventDefault();

                let basket_id = $(this).data('basket-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('delete_saved_basket') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        basket_id:basket_id
                    },
                    beforeSend: function () {
                        isLoading(true);
                    },
                    success: function (response) {

                        isLoading(false);
                        $('#basket_left_col').empty().append(response.left_col);
                        $('#basket_items').empty().append(response.right_col);
                    }
                });
            });
            {# End Update Basket #}

            {# Get Basket #}
            $(document).on('click', '.basket-link', function (e){

                e.preventDefault();

                let basketId = $(this).attr('data-basket-id');

                $('#btn_basket').attr('data-basket-id', basketId);

                if(basketId > 0)
                {
                    getBasket(basketId, true, '');
                }
            });
            $(document).on('click', '.distributor-clinic-connect', function (e) {

                e.preventDefault();

                let distributorId = $(this).data('distributor-id');
                let clinicId = $(this).data('clinic-id');
                let productId = $(this).data('product-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('clinic_request_connection') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        'distributor-id':distributorId,
                        'clinic-id': clinicId
                    },
                    beforeSend: function () {
                        isLoading(true);
                    },
                    complete: function(e, xhr, settings){
                        if(e.status === 500){
                            window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                    success: function (response) {

                        $('#modal_add_to_basket_'+ productId +'_'+ distributorId).modal('toggle');
                        getFlash(response);
                        isLoading(false);
                    }
                });
            });
            {# End Get Basket #}

            {# Back To Search #}
            $(document).on('click', '#return_to_search', function (e){

                e.preventDefault();

                $('#basket_container').empty().hide();
                $('.basket-id').attr('data-basket-id', $('#btn_basket').attr('data-basket-id'));
                $('#inventory_container').show();
            });
            {# End Back To Search #}

            {# Checkout #}
            $(document).on('click', '#btn_checkout', function (e){

                e.preventDefault();

                $.ajax({
                    async: "true",
                    url: "{{ path('checkout_options') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        basket_id: $(this).data('basket-id'),
                        permissions: '{{ permissions|json_encode }}'
                    },
                    beforeSend: function (){
                        isLoading(true);
                    },
                    complete: function(e, xhr, settings){
                        if(e.status === 500){
                            window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                    success: function (response) {

                        $('#modal_address').remove();
                        $('#basket_header, #basket_action_row_1, #basket_action_row_2, #basket_inner').empty();
                        $('#saved_items, #modal_address').remove();
                        $('#basket_inner').append(response.body);
                        $('#basket_header').empty().append(response.header);
                        $('#shipping_address_id').val(response.default_address_id);
                        $('#billing_address_id').val(response.default_billing_address_id);
                        $('#address_modal_label').empty().append('Select an Existing Address');
                        $('.modal-header').empty()
                            .append('<h5 class="modal-title" id="address_modal_label">Use an Existing Address</h5>')
                            .append('<span class="badge bg-success ms-3 toggle_address" role="button">Create A New Address</span>')
                            .append('<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>');
                        $('.modal-body-address-new').hide();
                        $('.modal-body-address-existing').append(response.existing_shipping_addresses).show();
                        isLoading(false);
                        $('#modal_header_address').empty()
                            .append('<h5 class="modal-title" id="address_modal_label">Use an Existing Address</h5>')
                            .append('<span class="badge bg-success ms-3 toggle_address" role="button">Create A New Address</span>')
                            .append('<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>');
                        $('#btn_checkout').hide();
                    }
                });
            });
            $(document).on('click', '.toggle_address', function (e){

                e.preventDefault();

                if($('.modal-body-address-new:visible').is(':visible')) {

                    $('#modal_header_address').empty()
                        .append('<h5 class="modal-title" id="address_modal_label">Use an Existing Address</h5>')
                        .append('<span class="badge bg-success ms-3 toggle_address" role="button">Create A New Address</span>')
                        .append('<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>');
                    $('.existing-address').attr('disabled', false);

                } else {

                    $('#modal_header_address').empty()
                        .append('<h5 class="modal-title" id="address_modal_label">Create A New Address</h5>')
                        .append('<span class="badge bg-success ms-3 toggle_address" role="button">Use an Existing Address</span>')
                        .append('<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>');
                    $('.existing-address').attr('disabled', true);
                }

                $('.modal-body-address-new').toggle();
                $('.modal-body-address-existing').toggle();
            });
            $(document).on('submit', '#form_checkout_options', function (e){

                e.preventDefault();

                let confirmation_email = $('#confirmation_email').val();
                let shipping_address = $('#shipping_address_id').val();
                let billing_address = $('#billing_address_id').val();
                let error_confirmation_email = $('#error_confirmation_email');
                let error_shipping_address = $('#error_shipping_address');
                let error_billing_address = $('#error_billing_address');
                let data = new FormData(this);
                let is_valid = true;

                error_confirmation_email.hide();
                error_shipping_address.hide();
                error_billing_address.hide();

                if(confirmation_email == '' || confirmation_email == 'undefined'){

                    error_confirmation_email.show();
                    is_valid = false;
                }

                if(shipping_address == '' || shipping_address == 'undefined'){

                    error_shipping_address.show();
                    is_valid = false;
                }

                if(billing_address == '' || billing_address == 'undefined'){

                    error_billing_address.show();
                    is_valid = false;
                }

                if(is_valid) {

                    $.ajax({
                        async: "true",
                        url: "{{ path('checkout_save_options') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        beforeSend: function (){
                            isLoading(true);
                        },
                        success: function (response) {

                            $('#basket_inner').empty().append(response);
                            isLoading(false);
                        }
                    });
                }
            });
            $(document).on('click', '#btn_place_order', function (e){

                e.preventDefault();

                let order_id = $(this).data('order-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('checkout_place_order') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        order_id: order_id,
                        permissions: '{{ permissions|json_encode }}'
                    },
                    beforeSend: function () {

                        isLoading(true);
                        window.scrollTo(0, 0);
                        $('body').scrollTop($('body').prop("scrollHeight"));
                    },
                    complete: function(e, xhr, settings){
                        if(e.status === 500){
                            window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                    success: function (response) {

                        isLoading(false);
                        getFlash(response.flash);
                        $('#inventory_container').hide();
                        $('#basket_container').empty().append(response.orders.html).show();
                        $('#paginator').empty().append(response.orders.pagination).show();
                        $('#btn_basket').attr('data-basket-id', response.basket_id);
                        window.scrollTo(0, 0);
                        $('body').scrollTop($('body').prop("scrollHeight"));
                        window.history.pushState(null, "Fluid", '/clinics/orders/'+ response.clinic_id);
                    }
                });
            });

            {# Orders #}
            {# Orders List #}
            function getOrdersList(clinic_id, page_id, distributor_id,date,status){

                $.ajax({
                    async: "true",
                    url: "{{ path('clinic_get_order_list') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        page_id: page_id,
                        clinic_id: clinic_id,
                        distributor_id: distributor_id,
                        date: date,
                        status: status
                    },
                    beforeSend: function (){

                        isLoading(true)
                    },
                    complete: function(e, xhr, settings){
                        if(e.status === 500){
                            window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                    success: function (response) {
                        $('#inventory_container').hide();
                        $('#basket_container').empty().append(response.html).show();
                        $('#paginator').empty().append(response.pagination).show();
                        window.scrollTo(0,0);
                        isLoading(false);
                        window.history.pushState(null, "Fluid", '/clinics/orders/'+ clinic_id);

                        let selector = '#datepicker';

                        if ($(window).width() < 769){

                            selector = '#datepicker_mobile';
                            $('.distributor_select').removeClass('me-2');
                            $('.status_select').removeClass('me-2 ms-3');
                        }

                        const picker = new easepick.create({
                            element: selector,
                            css: [
                                'https://cdn.jsdelivr.net/npm/@easepick/bundle@1.2.0/dist/index.css',
                                '{{ asset('css/date_picker.min.css') }}',
                            ],
                            zIndex: 11,
                            readonly: false,
                            plugins: [
                                "AmpPlugin",
                                "RangePlugin",
                            ]
                        })
                    }
                });
            }

            $('#orders_link').click( function (e){

                let clinic_id = $(this).data('clinic-id');


                e.preventDefault();
                clearInterval(get_messages);
                getOrdersList(clinic_id, 1,'','','');
                $('.col-container').removeClass('col-container');

            });
            $(document).on('click','.order-link, .orders_link', function (e){

                let clinic_id = $(this).data('clinic-id');
                e.preventDefault();
                clearInterval(get_messages);
                getOrdersList(clinic_id, $(this).data('page-id'),'','','');
                $('.col-container').removeClass('col-container');

            });
            $(document).on('change', '.distributor_select', function (){
                $('.distributor_search').attr('data-distributor-id', $(this).val());
            });
            setInterval(function(){

                if($('#datepicker_mobile').val() != '' && $('#datepicker_mobile').val() != 'Date') {

                    $('.distributor_search').attr('data-date', $('#datepicker_mobile').val());
                }

                if($('#datepicker').val() != '' && $('#datepicker').val() != 'Date') {

                    $('.distributor_search').attr('data-date', $('#datepicker').val());
                }
            } , 1000);
            $(document).on('change', '.status_select', function (){
                $('.distributor_search').attr('data-status-id', $(this).val());
            });
            $(document).on('click', '.distributor_refresh', function (){

                $('.datepicker').val('');
                $('.distributor_select').val('');
                $('.status_select').val('');

                let clinic_id = $(this).data('clinic-id');

                getOrdersList(clinic_id, 1, '','','');
            });
            $(document).on('click', '.distributor_search', function (){

                let distributor_id = $(this).attr('data-distributor-id');
                let date = $(this).attr('data-date');
                let clinic_id = $(this).data('clinic-id');
                let status = $(this).attr('data-status-id');

                getOrdersList(clinic_id, 1, distributor_id, date, status);
            });
            $(document).on('click', '#filter_orders', function (){
                $('#filter_row').toggle(700, 'linear');
            });
            {# Order Details #}
            function getOrderDetails(order_id, distributor_id, clinic_id){

                $.ajax({
                    async: "true",
                    url: "{{ path('clinic_get_order_details') }}",
                    type: 'POST',
                    data: {
                        order_id: order_id,
                        distributor_id: distributor_id,
                        permissions: '{{ permissions|json_encode }}'
                    },
                    dataType: 'json',
                    {#complete: function(e, xhr, settings){#}
                    {#    if(e.status === 500){#}
                    {#        window.location.href = '{{ path('clinic_error_500') }}';#}
                    {#    }#}
                    {#},#}
                    success: function (response) {

                        $('#basket_container').empty().append(response);
                        $('#inventory_container').hide();
                        $('#distributor_chat_inner').scrollTop($('#distributor_chat_inner').prop("scrollHeight"));
                        getChat(order_id, distributor_id, clinic_id);
                        $('#chat_pulse').hide();
                        popOver();
                        $('#paginator').hide();
                    }
                });
            }
            $(document).on('click', '#order_detail_link, .refresh-clinic-order', function (e){

                e.preventDefault();

                order_id = $(this).data('order-id');
                distributor_id = $(this).data('distributor-id');
                let clinic_id = $(this).data('clinic-id');

                window.history.pushState(null, "Fluid", '/clinics/order/'+ order_id +'/'+ distributor_id);
                hidePaginator();
                getOrderDetails(order_id, distributor_id, clinic_id);
            });
            $(document).on('click', '.order_notification_alert', function (e){

                e.preventDefault();

                order_id = $(this).data('order-id');
                distributor_id = $(this).data('distributor-id');
                let clinic_id = $(this).data('clinic-id');

                getOrderDetails(order_id, distributor_id, clinic_id);

                let notificationId = $(this).data('notification-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('delete_notifications') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        'notification-id': notificationId,
                        'type': 'clinic',
                    }
                });

                window.history.pushState(null, "Fluid", '/clinics/order/'+ order_id +'/'+ distributor_id);
            });
            $(document).on('click', '.order_item_accept', function (e){

                e.preventDefault();

                let order_id = $(this).data('order-id');
                let item_id = $(this).data('item-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('clinic_update_order_item_status') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        order_id: order_id,
                        item_id: item_id,
                        link: 'accept'
                    },
                    beforeSend: function () {
                        isLoading(true);
                    },
                    success: function (response) {
                        $('#order_item_accept_'+ item_id).removeClass('badge-success-outline-only badge-success-sm').addClass(response.class);
                        $('#order_item_renegotiate_'+ item_id).removeClass('bg-warning badge-warning-filled-sm').addClass('badge-warning-outline-only badge-warning-sm');
                        $('#order_item_cancel_'+ item_id).removeClass('bg-danger badge-danger-filled-sm').addClass('badge-danger-outline-only badge-danger-sm');
                        isLoading(false);
                        $('#btn_confirm_order').remove();
                        $('#btn_cancel_order').remove();
                        $('#order_action_row').append(response.btn);
                    }
                });
            });
            $(document).on('click', '.order_item_renegotiate', function (e){

                e.preventDefault();

                let order_id = $(this).data('order-id');
                let item_id = $(this).data('item-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('clinic_update_order_item_status') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        order_id: order_id,
                        item_id: item_id,
                        link: 'renegotiate'
                    },
                    beforeSend: function () {
                        isLoading(true);
                    },
                    success: function (response) {

                        $('#order_item_accept_'+ item_id).removeClass('bg-success badge-success-filled-sm').addClass('badge-success-outline-only badge-success-sm');
                        $('#order_item_renegotiate_'+ item_id).removeClass('badge-warning-outline-only badge-warning-sm').addClass(response.class);
                        $('#order_item_cancel_'+ item_id).removeClass('bg-danger badge-danger-filled-sm').addClass('badge-danger-outline-only badge-danger-sm');
                        $('#btn_confirm_order').remove();
                        $('#btn_cancel_order').remove();
                        isLoading(false);
                        $('#order_action_row').append(response.btn);
                    }
                });
            });
            $(document).on('click', '.order_item_cancel', function (e){

                e.preventDefault();

                let order_id = $(this).data('order-id');
                let item_id = $(this).data('item-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('clinic_update_order_item_status') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        order_id: order_id,
                        item_id: item_id,
                        link: 'cancelled'
                    },
                    beforeSend: function () {
                        isLoading(true);
                    },
                    success: function (response) {
                        $('#order_item_accept_'+ item_id).removeClass('bg-success badge-success-filled-sm').addClass('badge-success-outline-only badge-success-sm');
                        $('#order_item_renegotiate_'+ item_id).removeClass('bg-warning badge-warning-filled-sm').addClass('badge-warning-outline-only badge-warning-sm');
                        $('#order_item_cancel_'+ item_id).removeClass('badge-danger-outline-only badge-danger-sm').addClass(response.class);
                        isLoading(false);
                        $('#btn_confirm_order').remove();
                        $('#btn_cancel_order').remove();
                        $('#order_action_row').append(response.btn);
                    }
                });
            });
            $(document).on('click', '#btn_confirm_order', function (e){

                e.preventDefault();

                let order_id = $(this).data('order-id');
                let distributor_id = $(this).data('distributor-id');
                let clinic_id = $(this).data('clinic-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('clinic_confirm_order') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        order_id: order_id,
                        distributor_id: distributor_id,
                        clinic_id: clinic_id
                    },
                    beforeSend: function () {
                        isLoading(true);
                    },
                    success: function (response) {
                        getFlash(response.flash);
                        $('#basket_container').empty().removeClass('col-container').append(response.orders.html).show();
                        clearInterval(get_messages);
                        isLoading(false);
                        window.history.pushState(null, "Fluid", '/clinics/orders/'+ response.clinic_id);
                    }
                });
            });
            $(document).on('change', '#order_status', function (e){

                let order_status = $('#order_status').val();
                let order_id = $(this).data('order-id');
                let distributor_id = $(this).data('distributor-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('clinic_update_order_status') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        order_status: order_status,
                        distributor_id: distributor_id,
                        order_id: order_id,
                        permissions: '{{ permissions|json_encode }}',
                    },
                    beforeSend: function () {
                        isLoading(true);
                    },
                    success: function (response) {
                        $('#basket_container').empty().append(response);
                        isLoading(false);
                    },
                    complete: function(e, xhr, settings){
                        if(e.status === 500){
                            window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                });
            });
            $(document).on('change', '.order-qty-delivered', function (){

                let uri = window.location.pathname;
                let pieces = uri.split("/");

                let item_id = $(this).data('qty-delivered-id');
                let order_id = pieces[3]
                let distributor_id = pieces[4]
                let qty = $(this).val();

                if(qty == '' || qty == 'undefined'){

                    qty = 0;
                }

                $.ajax({
                    async: "true",
                    url: "{{ path('clinic_update_qty_delivered') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        item_id: item_id,
                        qty: qty,
                        distributor_id: distributor_id,
                        order_id: order_id
                    },
                    beforeSend: function (){
                        isLoading(true);
                    },
                    success: function (response) {

                        getFlash(response.flash);
                        $('#basket_container').empty().append(response.orders);

                        isLoading(false);
                    }
                });
            });
            $(document).on('click', '.qty-correct', function (){

                let item_id = $(this).data('item-id');
                let order_id = '{{ app.request.get('order_id') }}'
                let distributor_id = '{{ app.request.get('distributor_id') }}'

                $.ajax({
                    async: "true",
                    url: "{{ path('is_delivered_quantity_correct') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        item_id: item_id,
                        order_id: order_id,
                        distributor_id: distributor_id,
                        is_correct: 1,
                        is_incorrect: 0
                    },
                    beforeSend: function (){
                        isLoading(true);
                    },
                    success: function (response) {

                        getFlash(response.flash);
                        $('#basket_container').empty().append(response.orders);

                        isLoading(false);
                    }
                });
            });
            $(document).on('click', '.qty-incorrect', function (){

                let item_id = $(this).data('item-id');
                let order_id = '{{ app.request.get('order_id') }}'
                let distributor_id = '{{ app.request.get('distributor_id') }}'

                $.ajax({
                    async: "true",
                    url: "{{ path('is_delivered_quantity_correct') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        item_id: item_id,
                        order_id: order_id,
                        distributor_id: distributor_id,
                        is_correct: 0,
                        is_incorrect: 1
                    },
                    beforeSend: function (){
                        isLoading(true);
                    },
                    success: function (response) {

                        getFlash(response.flash);
                        $('#basket_container').empty().append(response.orders);

                        isLoading(false);
                    }
                });
            });
            $(document).on('click', '.btn-item-accept', function (e){

                e.preventDefault();

                let item_id = $(this).data('item-id');
                let uri = window.location.pathname.split('/');
                let order_id = uri[3];
                let distributor_id = uri[4];

                $.ajax({
                    async: "true",
                    url: "{{ path('is_delivered_accept') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        item_id: item_id,
                        order_id: order_id,
                        distributor_id: distributor_id,
                        permissions: '{{ permissions|json_encode }}',
                    },
                    beforeSend: function (){
                        isLoading(true);
                    },
                    success: function (response) {

                        getFlash(response.flash);
                        $('#basket_container').empty().append(response.orders);
                        popOver();
                        isLoading(false);
                    },
                    complete: function(e, xhr, settings){
                        if(e.status === 500){
                            window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                });
            });
            $(document).on('click', '.btn-item-qty', function (e){

                e.preventDefault();

                let item_id = $(this).data('item-id');
                let uri = window.location.pathname.split('/');
                let order_id = uri[3];
                let distributor_id = uri[4];

                $.ajax({
                    async: "true",
                    url: "{{ path('is_delivered_qty') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        item_id: item_id,
                        order_id: order_id,
                        distributor_id: distributor_id,
                        permissions: '{{ permissions|json_encode }}',
                    },
                    beforeSend: function (){
                        isLoading(true);
                    },
                    success: function (response) {

                        getFlash(response.flash);
                        $('#basket_container').empty().append(response.orders);
                        popOver();
                        isLoading(false);
                    },
                    complete: function(e, xhr, settings){
                        if(e.status === 500){
                            window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                });
            });
            $(document).on('click', '.btn-item-reject', function (e){

                e.preventDefault();

                let item_id = $(this).data('item-id');
                let reject_reason_error = $('#error_reject_reason');

                $('#reject_item_id').val(item_id);
                reject_reason_error.hide();

                $.ajax({
                    async: "true",
                    url: "{{ path('clinics_get_reject_reason') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        item_id: item_id
                    },
                    success: function (response) {

                        $('#reject_reason').val(response);
                    },
                });

            });
            $(document).on('submit', 'form[name="form_reject_item"]', function (e){

                e.preventDefault();

                let reject_reason = $('#reject_reason').val();
                let reject_reason_error = $('#error_reject_reason');
                let is_valid = true;

                reject_reason_error.hide();

                if(reject_reason == '' || reject_reason == 'undefined'){

                    reject_reason_error.show();
                    is_valid = false;
                }

                if(is_valid) {

                    let data = new FormData(this);
                    let permissions = '{{ permissions|json_encode }}';

                    for (let i = 0; i < permissions.length; i++) {
                        data.append('permissions[]', permissions[i]);
                    }

                    $.ajax({
                        async: "true",
                        url: "{{ path('clinics_reject_item') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        beforeSend: function (){
                            isLoading(true);
                        },
                        success: function (response) {
                            getFlash(response.flash);
                            $('#basket_container').empty().append(response.orders);
                            $('#form_reject_item').modal('toggle').modal('hide');
                            $('.modal-backdrop').removeClass('modal-backdrop');
                            $('.fade').removeClass('fade');
                            isLoading(false);
                            popOver();
                        },
                        complete: function(e, xhr, settings){
                            if(e.status === 500){
                                window.location.href = '{{ path('clinic_error_500') }}';
                            }
                        }
                    });
                }
            });
            $(document).on('click', '.qty-complete, .qty-rejected', function (){

                let item_id = $(this).data('item-id');
                let order_id = '{{ app.request.get('order_id') }}'
                let distributor_id = '{{ app.request.get('distributor_id') }}'

                $.ajax({
                    async: "true",
                    url: "{{ path('is_delivered_quantity_correct') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        item_id: item_id,
                        order_id: order_id,
                        distributor_id: distributor_id,
                        is_correct: 0,
                        is_incorrect: 0
                    },
                    beforeSend: function (){
                        isLoading(true);
                    },
                    success: function (response) {

                        getFlash(response.flash);
                        $('#basket_container').empty().append(response.orders);

                        isLoading(false);
                    }
                });
            });
            $(document).on('click', '#close_order', function(e){

                let order_id = $(this).data('order-id');
                let distributor_id = $(this).data('distributor-id');

                let modal = '<div class="modal fade" id="modal_close_order" tabindex="-1" aria-labelledby="user_delete_label" aria-hidden="true">';
                modal += '<div class="modal-dialog modal-dialog-centered">';
                modal += '<div class="modal-content">';
                modal += '<input type="hidden" value="" name="addresses_form[address_id]" id="address_id">';
                modal += '<div class="modal-body">';
                modal += '<div class="row">';
                modal += '<div class="col-12 mb-0">';
                modal += 'Are you sure you would like to close this order? This action cannot be undone.';
                modal += '</div>';
                modal += '</div>';
                modal += '</div>';
                modal += '<div class="modal-footer">';
                modal += '<button type="button" class="btn btn-primary btn-sm" data-bs-dismiss="modal">CANCEL</button>';
                modal += '<button type="submit" data-order-id="'+ order_id +'" data-distributor-id="'+ distributor_id +'" class="btn btn-danger btn-sm" id="btn_close_order">CLOSE ORDER</button>';
                modal += '</div> </div> </div> </div>';

                $('#basket_container').append(modal);
                $('#modal_close_order').modal('toggle').addClass('show');
            });
            $(document).on('click', '#btn_close_order', function (){

                let order_id = $(this).data('order-id');
                let distributor_id = $(this).data('distributor-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('clinic_update_order_status') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        order_status: 8,
                        distributor_id: distributor_id,
                        order_id: order_id
                    },
                    beforeSend: function () {
                        isLoading(true);
                    },
                    success: function (response) {
                        $('#basket_container').empty().append(response);
                        isLoading(false);
                        $('#modal_close_order').modal('toggle');
                        $('#modal_close_order').modal('hide');
                        $('.modal-backdrop').removeClass('modal-backdrop');
                        $('#modal_close_order').addClass('fade');
                    }
                });
            });
            {# Instant Messenger #}
            let order_id = $('#chat_field').data('order-id');
            let distributor_id = $('#chat_field').data('distributor-id');

            $(document).on('click','#chat_field', function () {

                let order_id = $(this).data('order-id');
                let distributor_id = $(this).data('distributor-id');
                let clinic_id = $(this).data('clinic_id');

                $.ajax({
                    async: "true",
                    url: "{{ path('is_typing') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        order_id: order_id,
                        distributor_id: distributor_id,
                        is_clinic: 1,
                        is_distributor: 0,
                        is_typing: 1,
                    },
                    success: function (response) {

                        if(response.distributor_is_typing > 0) {

                            $('#chat_pulse').show();

                        } else {

                            $('#chat_pulse').hide();
                        }
                    }
                });
            });
            $(document).on('blur','#chat_field', function (){

                $.ajax({
                    async: "true",
                    url: "{{ path('is_typing') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        order_id: orderid,
                        distributor_id: distributorid,
                        is_typing: 0,
                        is_clinic: 1,
                        is_distributor: 0,
                    }
                });
            });
            $(document).on('click', '#btn_chat_send', function (e){

                e.preventDefault();

                let message = $('#chat_field').val();
                let distributorId = $(this).data('distributor-id');
                let orderId = $(this).data('order-id');

                sendMessage(message, distributorId, orderId);
            });
            $(document).on('keyup keypress', '#chat_field', function (e)
            {
                if (e.key === 'Enter' || e.keyCode === 13)
                {
                    e.preventDefault();

                    let message = $('#chat_field').val();
                    let distributorId = $(this).data('distributor-id');
                    let orderId = $(this).data('order-id');

                    sendMessage(message, distributorId, orderId);
                }
            });
            function sendMessage(message, distributorId, orderId)
            {
                if(message.length > 0){

                    $.ajax({
                        url:"{{ path('distributor_send_message') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            distributor: 0,
                            clinic: 1,
                            distributor_id: distributorId,
                            message: message,
                            order_id: orderId,
                        },
                        success: function(response) {

                            $('#distributor_chat_container').empty().append(response);
                            $('#distributor_chat_inner').scrollTop($('#distributor_chat_inner').prop("scrollHeight"));
                            $('#chat_field').val('');

                            {# Email Notification #}
                            $.ajax({
                                url:"{{ path('im_notification') }}",
                                type: 'POST',
                                dataType: 'json',
                                data: {
                                    distributor: 0,
                                    clinic: 1,
                                    distributor_id: distributorId,
                                    message: message,
                                    order_id: orderId,
                                },
                                success: function(response) {

                                    console.log('Email Sent...')
                                }
                            });
                        }
                    });
                }
            }
            function getMessages(order_id, distributor_id, clinic_id){

                let uri = window.location.pathname;
                let isOrderDetail = uri.match('/[a-zA-Z]+/[a-zA-Z]+/[0-9]+/[0-9]+');
                if(isOrderDetail != null) {

                    let messages_sent = $('.speech-bubble-right').length;
                    let messages_received = $('.speech-bubble-left').length;
                    let total_messages = messages_sent + messages_received;

                    $.ajax({
                        async: "true",
                        url: "{{ path('get_messages') }}",
                        type: 'GET',
                        cache: false,
                        timeout: 10000,
                        data: {
                            distributor: 0,
                            clinic: 1,
                            order_id: order_id,
                            distributor_id:distributor_id,
                            clinic_id: clinic_id,
                            total_messages:total_messages
                        },
                        success: function (response) {

                            if(response.messages.length > 0){

                                $('#distributor_chat_container').empty().append(response.messages);
                                $('#distributor_chat_inner').scrollTop($('#distributor_chat_inner').prop("scrollHeight"));
                            }

                            if(response.is_typing == 1) {

                                $('#chat_pulse').show();

                            } else {

                                $('#chat_pulse').hide();
                            }
                        }
                    });
                }
            };
            function getChat(order_id, distributor_id, clinic_id) {
                get_messages = setInterval(function(){
                    getMessages(order_id, distributor_id, clinic_id);
                }, 1000);
            }
            {# End Checkout #}
            {# End Basket #}

            let rating = 0;
            let product_id = 0;
            let note_id = 0;
            let basket_product_id = 0
            distributor_id = 0;

            {# Panels #}
            function getSearchPanelsHeader(){

                $('.search-panels-header').empty();
            }
            {# Details #}
            $(document).on('click', '.btn_details', function(){

                product_id = $(this).data('product-id');
                $('.panel_lists').empty();

                if($('#details_'+ product_id +':visible').length) {

                    $('#details_'+ product_id).slideUp(700);
                    $('#search_panels_container_'+ product_id).slideUp(700);
                    $('#btn_details_'+ product_id).removeClass('active');

                } else {

                    $('#search_panels_container_'+ product_id).show();
                    $('#lists_'+ product_id).slideUp(700);
                    $('#track_'+ product_id).slideUp(700);
                    $('#notes_'+ product_id).slideUp(700);
                    $('#reviews_'+ product_id).slideUp(700);
                    $('#details_'+ product_id).slideDown(700);
                    $('#btn_details_'+ product_id).addClass('active');
                    $('#btn_lists_'+ product_id).removeClass('active');
                    $('#btn_track_'+ product_id).removeClass('active');
                    $('#btn_notes_'+ product_id).removeClass('active');
                    $('#btn_reviews_'+ product_id).removeClass('active');
                }
            });
            {# End Details #}

            {# Order Lists #}
            let item_qty = '';
            function getShoppingLists(keyword){

                $.ajax({
                    async: "true",
                    url: "{{ path('manage_lists') }}",
                    type: 'POST',
                    cache: false,
                    timeout: 600000,
                    dataType: 'json',
                    data: {
                        list_id: 0,
                        keyword: keyword,
                        permissions: '{{ permissions|json_encode }}'
                    },
                    beforeSend: function () {

                        isLoading(true);
                    },
                    success: function (response) {

                        $('#inventory').hide();
                        $('#inventory_container').hide();
                        $('#basket_container').empty().addClass('col-container').removeClass('border-xy').append(response.response).show();
                        window.scrollTo(0,0);
                        getBackButton();
                        window.history.pushState(null, "Fluid", '/clinics/inventory/lists');
                    },
                    complete: function(e, xhr, settings){
                        {#if(e.status === 500){#}
                        {#    window.location.href = '{{ path('clinic_error_500') }}';#}
                        {#}#}

                        isLoading(false);
                    }
                });
            }
            function getSingleShoppingList(listId)
            {
                $.ajax({
                    async: "true",
                    url: "{{ path('inventory_edit_list') }}",
                    type: 'POST',
                    cache: false,
                    timeout: 600000,
                    dataType: 'json',
                    data: {
                        'list-id': listId,
                        permissions: '{{ permissions|json_encode }}'
                    },
                    beforeSend: function () {

                      isLoading(true);
                    },
                    success: function (response) {

                        $('#inventory').hide();
                        $('#inventory_container').hide();
                        $('#basket_container').empty().append(response.html).show();
                        isLoading(false);
                        getBackButton();
                        popOver();

                        var maxWidth = Math.max.apply( null, $( '.stock-status' ).map( function () {
                            return $( this ).outerWidth( true );
                        }).get() );

                        $('.stock-status').css({'width':maxWidth+'px'});

                        window.history.pushState(null, "Fluid", '/clinics/inventory/manage/list/'+ listId);
                    },
                    complete: function(e, xhr, settings){
                        if(e.status === 500){
                            window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                });
            }
            $(document).on('click', '.view-list', function (){
                $('#back_btn').empty().hide();
            });
            $(document).on('click', '.btn_lists', function(){

                product_id = $(this).data('product-id');

                if($('#lists_'+ product_id +':visible').length) {

                    $('#lists_'+ product_id).slideUp(700);
                    $('#search_panels_container_'+ product_id).slideUp(700);
                    $('#btn_lists_'+ product_id).removeClass('active').removeClass('active');

                } else {

                    let keyword = '';

                    if($('#search_field').val() != '' || $('#search_field').val() != 'undefined') {

                        keyword = $('#search_field').val();
                    }

                    $.ajax({
                        async: "true",
                        url: "{{ path('inventory_get_lists') }}",
                        type: 'POST',
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: {
                            id: product_id,
                            keyword: keyword,
                            permissions: '{{ permissions|json_encode }}',
                        },
                        success: function (response) {
                            $('#lists_'+ product_id).empty();
                            $('#lists_'+ product_id).append(response);
                            //$('#inventory_container').css({overflow:"auto"});
                        }
                    });

                    $('#search_panels_container_'+ product_id).show();
                    $('#details_'+ product_id).slideUp(700);
                    $('#track_'+ product_id).slideUp(700);
                    $('#notes_'+ product_id).slideUp(700);
                    $('#reviews_'+ product_id).slideUp(700);
                    $('#lists_'+ product_id).slideDown(700);
                    $('#btn_details_'+ product_id).removeClass('active');
                    $('#btn_lists_'+ product_id).addClass('active');
                    $('#btn_track_'+ product_id).removeClass('active');
                    $('#btn_notes_'+ product_id).removeClass('active');
                    $('#btn_reviews_'+ product_id).removeClass('active');
                }
            });
            $(document).on('click', ".list_add_item", function (e)
            {
                e.preventDefault();

                let productId = $(this).data("id");
                let listId = $(this).data("value");

                $('#save_list_distributor').removeAttr('data-favourite');

                $.ajax({
                    async: "true",
                    url: "{{ path('inventory_get_list_modal') }}",
                    type: 'POST',
                    cache: false,
                    timeout: 600000,
                    dataType: 'json',
                    data: {
                        'product-id': productId,
                        'list-id': listId,
                    },
                    success: function (response)
                    {
                        $('#modal_list_distributors').remove();
                        $('#inventory_container').append(response);
                        $('#modal_list_distributors').modal('toggle');
                        $('body').css('overflow', '');
                    }
                });
            });
            $(document).on('click', "#save_list_distributor", function (e)
            {
                e.preventDefault();

                let uri = window.location.pathname;
                let listId = $(this).data("value");
                let productId = $(this).data("id");
                let distributorId = $('#list_distributor_id').val();
                let unitPrice = $('#unit_price').val() ? $('#unit_price').val() : '0.00';
                let isValid = true;
                let isManageList = uri.match('/clinics/inventory/manage/list/[0-9]+');
                let favourite = (this).hasAttribute('data-favourite');
                let retail = (this).hasAttribute('data-retail');

                if(
                    listId == '' || listId == 'undefined' || productId == '' || productId == 'undefined' ||
                    distributorId == '' || distributorId == 'undefined')
                {
                    isValid = false;
                }

                if(isValid){

                    $.ajax({
                        async: "true",
                        url: "{{ path('inventory_manage_list') }}",
                        type: 'POST',
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: {
                            'product-id': productId,
                            'list-id': listId,
                            'distributor-id': distributorId,
                            'unit-price': unitPrice,
                            'favourite': favourite,
                            'retail': retail,
                            permissions: '{{ permissions|json_encode }}',
                            'return': '',
                        },
                        success: function (response)
                        {
                            if(response.is_favourite != undefined)
                            {
                                $('#favourite_'+ productId).removeClass('icon-unchecked').addClass('text-danger')
                                    .attr('data-favourite', true).attr('data-distributor-id', distributorId);
                            } else if(response.isRetail != undefined)
                            {
                                $('#retail_'+ productId).removeClass('icon-unchecked').addClass('text-danger')
                                    .attr('data-retail', true).attr('data-distributor-id', distributorId);
                            }
                            else
                            {
                                if (isManageList != null)
                                {
                                    getSingleShoppingList(listId);
                                }
                                else if($(this).data('favourite') != undefined)
                                {
                                    if (response == true)
                                    {
                                        $('#favourite_' + productId).removeClass('icon-unchecked').addClass('text-danger');
                                    }
                                    else
                                    {
                                        $('#favourite_' + productId).removeClass('text-secondary').addClass('icon-unchecked');
                                    }

                                }
                                else
                                {
                                    $('#lists_' + productId).empty().append(response);
                                }
                            }

                            $('#modal_list_distributors').modal('toggle');
                        }
                    });
                }
            });
            $(document).on('click', ".list_remove_item", function (e){

                e.preventDefault();

                let list_id = $(this).data("value");
                let product_id = $(this).data("id");
                let is_valid = true;

                if(list_id == '' || list_id == 'undefined' || product_id == '' || product_id == 'undefined'){

                    is_valid = false;
                }

                if(is_valid){

                    $.ajax({
                        async: "true",
                        url: "{{ path('inventory_delete_list_item') }}",
                        type: 'POST',
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: {
                            product_id: product_id,
                            list_id: list_id,

                        },
                        success: function (response) {
                            $('#lists_'+ product_id).empty().append(response);

                        }
                    });
                }
            });
            $(document).on('submit', '#form_list', function (e){

                e.preventDefault();

                let list_name = $('#list_name').val();
                let list_name_error = $('#error_list_name');
                let data = new FormData(this);
                let is_valid = true;

                list_name_error.hide()

                if(list_name == '' || list_name == 'undefined'){

                    list_name_error.show();
                    is_valid = false;
                }

                if(is_valid) {

                    $.ajax({
                        async: "true",
                        url: "{{ path('inventory_manage_list') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        success: function (response) {
                            $('#lists_'+ product_id).empty().append(response);
                        }
                    });
                }
            });
            $(document).on('click', ".manage-lists", function (e){

                e.preventDefault();
                let keyword = '';

                if($(this).data('keyword-string').length > 0){

                    keyword = $(this).data('keyword-string');
                }

                getShoppingLists(keyword);
            });
            $(document).on('click', ".delete-list", function (e){

                e.preventDefault();

                let list_id = $(this).data('list-id');
                $('#delete_list').attr('data-list-id', list_id);
            });
            $(document).on('click', "#delete_list", function (e){

                e.preventDefault();

                let list_id = $(this).data('list-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('manage_lists') }}",
                    type: 'POST',
                    cache: false,
                    timeout: 600000,
                    dataType: 'json',
                    data: {
                        list_id: list_id,
                    },
                    success: function (response) {

                        $('#modal_user_delete').modal('toggle');
                        $('#modal_user_delete').modal('hide');
                        $('.modal-backdrop').removeClass('modal-backdrop');
                        $('#modal_user_delete').addClass('fade');
                        getFlash(response.flash);
                        $('#inventory').hide();
                        $('#inventory_container').hide();
                        $('#basket_container').empty().addClass('col-container').append(response.response).show();
                        getBackButton();
                    }
                });
            });
            $(document).on('click', '.edit-list', function (e)
            {
                e.preventDefault();

                let listId = $(this).data('list-id');

                getSingleShoppingList(listId);
            });
            $(document).on('change', '.shopping-list-qty', function (){

                let list_item_id = $(this).data('list-item-id');
                let qty = $(this).val();
                let is_valid = true;
                $('#error_qty_'+ $(this).data('list-item-id')).hide();

                if(qty == 0 || qty == '' || qty == 'undefined'){

                    is_valid = false;
                    $('#error_qty_'+ $(this).data('list-item-id')).empty().append('Please select a valid quantity.').show();

                }

                if(is_valid) {

                    $.ajax({
                        async: "true",
                        url: "{{ path('inventory_list_update_qty') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            list_item_id: list_item_id,
                            qty: qty
                        },
                        beforeSend: function (){
                            isLoading(true);
                        },
                        success: function (response) {

                            if(response.list_id > 0){

                                getSingleShoppingList(response.list_id);
                            }

                            getFlash(response.flash);
                        },
                        complete: function(e, xhr, settings){
                            if(e.status === 500){
                                window.location.href = '{{ path('clinic_error_500') }}';
                            }

                            isLoading(false);
                        },
                    });
                }
            });
            $(document).on('click', '.remove-list-item', function (e){

                e.preventDefault();

                let item_id = $(this).data('item-id');

                if(item_id > 0){

                    $.ajax({
                        async: "true",
                        url: "{{ path('list_remove_item') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            list_item_id: item_id
                        },
                        beforeSend: function (){
                            isLoading(true);
                        },
                        success: function (response) {

                            $('#inventory').hide();
                            $('#inventory_container').hide();
                            $('#basket_container').empty().append(response.html).show();
                            getFlash(response.flash);
                            getBackButton();
                            popOver();

                            var maxWidth = Math.max.apply( null, $( '.stock-status' ).map( function () {
                                return $( this ).outerWidth( true );
                            }).get() );

                            $('.stock-status').css({'width':maxWidth+'px'});

                            if(!response.hasItems){

                                window.history.pushState(null, "Fluid", '/clinics/inventory/lists');
                            }
                        },
                        complete: function(e, xhr, settings){
                            if(e.status === 500){
                                window.location.href = '{{ path('clinic_error_500') }}';
                            }

                            isLoading(false);
                        },
                    });
                }
            });
            $(document).on('click', '.shopping-list-qty', function (){

                item_qty = $(this).val();
                $(this).val('');
            });
            $(document).on('blur', '.shopping-list-qty', function (){

                if($(this).val() == '' || $(this).val() == 'undefined'){

                    $(this).val(item_qty);
                };

            });
            $(document).on('click', '.list-add-basket', function (e){

                e.preventDefault();

                let list_id = $(this).data('list-id');
                let clinic_id = $(this).data('clinic-id');
                let clear_basket = $(this).data('basket-clear');
                let is_valid = true;

                if(
                    list_id == '' || list_id == 'undefined' || clinic_id == '' || clinic_id == 'undefined' ||
                    clear_basket === '' || clear_basket === 'undefined'
                ){

                    is_valid = false;
                }

                if(is_valid){

                    $.ajax({
                        async: "true",
                        url: "{{ path('list_add_to_basket') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            list_id: list_id,
                            clinic_id: clinic_id,
                            clear_basket: clear_basket
                        },
                        beforeSend: function (){
                            isLoading(true);
                        },
                        success: function (response) {

                            $('#modal_list_add_to_basket').modal('toggle');
                            $(".modal-backdrop").remove();
                            getBasket(response,true,'');

                        },
                        complete: function(e, xhr, settings){
                            if(e.status === 500){
                                window.location.href = '{{ path('clinic_error_500') }}';
                            }

                            isLoading(false);
                        },
                    });
                }
            });
            $(document).on('keyup', '#inventory_search', function(){

                $.ajax({
                    type: "POST",
                    async: "true",
                    url: "{{ path('clinics_list_inventory_search') }}",
                    data: {
                        keyword: $(this).val(),
                        list_id: $(this).data('list-id'),
                    },
                    success: function(data){
                        $("#suggestion_field").show();
                        $("#suggestion_field").html(data);
                    }
                });
            });
            $(document).on('click', '.list-item', function (e)
            {
                let productId = $(this).attr('data-product-id');
                let listId = $(this).attr('data-list-id');

                getProductDistributors(productId, listId);
            })
            {# End Order Lists #}

            {# Tracking #}
            $('#notifications_panel').hide();
            function getNotifications(){
                $.ajax({
                    url:"{{ path('get_notifications') }}",
                    type: 'POST',
                    cache:false,
                    timeout:10000,
                    dataType: 'json',
                    success: function(response) {

                        $('#notifications_panel').empty().append(response);
                    }
                });
            };

            $(document).on('click', 'a', function (){

                let name = $(this).attr('name');

                if(name != 'notifications'){

                    $('#notifications_panel').hide();
                }

            });
            $(document).on('click', '.btn_track', function(){

                product_id = $(this).data('product-id');

                if($('#track_'+ product_id +':visible').length) {

                    $('#track_'+ product_id).slideUp(700);
                    $('#search_panels_container_'+ product_id).slideUp(700);
                    $('#btn_track_'+ product_id).removeClass('active').removeClass('active');

                } else {

                    $.ajax({
                        async: "true",
                        url: "{{ path('get_availability_tracker') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            product_id: product_id
                        },
                        success: function (response) {

                            $('#track_'+ product_id).empty().append(response.html).append(response.list);
                            $('#search_panels_container_'+ product_id).show();
                            $('#details_'+ product_id).slideUp(700);
                            $('#lists_'+ product_id).slideUp(700);
                            $('#notes_'+ product_id).slideUp(700);
                            $('#reviews_'+ product_id).slideUp(700);
                            $('#track_'+ product_id).slideDown(700);
                            $('#btn_details_'+ product_id).removeClass('active');
                            $('#btn_lists_'+ product_id).removeClass('active');
                            $('#btn_track_'+ product_id).addClass('active');
                            $('#btn_notes_'+ product_id).removeClass('active');
                            $('#btn_reviews_'+ product_id).removeClass('active');
                        }
                    });
                }
            });
            $(document).on('submit', '#form_availability_tracker', function (e){

                e.preventDefault();

                let method_counter = 0;
                $("input[name='method[]']").each(
                    function (){
                        if(this.checked){
                            method_counter += 1;
                        }
                    }
                );

                let distributor_counter = 0;
                $("input[name='distributor[]']").each(
                    function (){
                        if(this.checked){
                            distributor_counter += 1;
                        }
                    }
                );

                let error_at_methods = $('#error_at_methods');
                let error_at_distributors = $('#error_at_distributors');
                let data = new FormData(this);
                let is_valid = true;

                error_at_methods.hide()
                error_at_distributors.hide();

                if(method_counter == 0){

                    error_at_methods.show();
                    is_valid = false;
                }

                if(distributor_counter == 0){

                    error_at_distributors.show();
                    is_valid = false;
                }

                if(is_valid) {

                    $.ajax({
                        async: "true",
                        url: "{{ path('create_availability_tracker') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        success: function (response) {
                            getFlash(response.flash);
                            $('#availability_tracker_row').show();
                            $('#availability_tracker_col').empty().append(response.list)
                        }
                    });
                }
            });
            {# Notifications #}
            $(document).on('click', '.availability-tracker-delete-icon', function (e){

                e.preventDefault();

                let tracker_id = $(this).data("availability-tracker-id");

                $('#delete_tracker').attr('data-delete-tracker-id', tracker_id);

            });
            $(document).on('click', '#delete_tracker', function (e){

                e.preventDefault();

                let tracker_id = $(this).data('delete-tracker-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('delete_availability_tracker') }}",
                    type: 'POST',
                    cache: false,
                    timeout: 600000,
                    dataType: 'json',
                    data: {
                        tracker_id: tracker_id
                    },
                    success: function (response) {
                        $('#modal_availability_tracker_delete').modal('hide');
                        $('.modal-backdrop').removeClass('modal-backdrop');
                        $('#availability_trackers').empty().append(response.html);
                        getFlash(response.flash);
                    }
                });
            });
            $(document).on('click', '.btn-notifications', function (e){

                e.preventDefault();
                getNotifications();

                $('#notifications_panel').slideToggle();
            });
            $(document).on('click', '.delete-notification', function (e){

                e.preventDefault();

                let notificationId = $(this).data('notification-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('delete_notifications') }}",
                    type: 'POST',
                    cache: false,
                    timeout: 600000,
                    dataType: 'json',
                    data: {
                        'notification-id': notificationId,
                        'type': 'clinic',
                    },
                    success: function (response) {

                        getFlash(response.flash);
                        getNotifications();
                    }
                });
            });
            $(document).on('click', '.notification-panel', function (e){

                e.preventDefault();

                let notificationId = $(this).data('notification-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('delete_notifications') }}",
                    type: 'POST',
                    cache: false,
                    timeout: 600000,
                    dataType: 'json',
                    data: {
                        'notification-id': notificationId,
                        'type': 'clinic',
                    },
                    success: function (response) {

                        getNotifications();
                    }
                });
            });

            function getNotifications(){

                $.ajax({
                    async: "true",
                    url: "{{ path('get_order_notification') }}",
                    type: 'GET',
                    cache: false,
                    timeout: 600000,
                    dataType: 'json',
                    data: {
                        'type': 'clinic',
                        'id': '{{ app.user.clinic.id|default(0) }}'
                    },
                    success: function (response) {

                        if(response.count > 0){

                            $('#notifications_icon').addClass('text-secondary');

                        } else {

                            $('#notifications_icon').removeClass('text-secondary');
                        }

                        $('#notifications_panel').empty().append(response.alert);
                    }
                });
            }
            setInterval(getNotifications, 1000);
            {# Close Notifications #}
            {# End Tracking #}

            {# Notes #}
            let note_count = 0;
            function getNoteCount(note_count,product_id){

                if(note_count > 0) {

                    let btn_note = '';

                    btn_note += '<i class="fa-solid fa-pencil"></i> <span class="d-none d-sm-inline">Notes</span>';
                    btn_note += '<span class="position-absolute text-opacity-25 start-100 translate-middle badge border rounded-circle bg-primary" ';
                    btn_note += 'style="z-index: 999">' + note_count + '</span>';

                    $('#btn_note_' + product_id).empty().append(btn_note);

                } else {

                    let btn_note = '';

                    btn_note += '<i class="fa-solid fa-pencil"></i> <span class="d-none d-sm-inline">Notes</span>';

                    $('#btn_note_' + product_id).empty().append(btn_note);
                }
            }
            $(document).on('click', '.btn_notes, .note_link', function(e){

                product_id = $(this).data('product-id');

                e.preventDefault();

                if($('#notes_'+ product_id +':visible').length) {

                    $('#notes_'+ product_id).slideUp(700);
                    $('#search_panels_container_'+ product_id).slideUp(700);
                    $('#btn_notes_'+ product_id).removeClass('active').removeClass('active');

                } else {

                    $.ajax({
                        async: "true",
                        url: "{{ path('inventory_get_notes') }}",
                        type: 'POST',
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: {
                            id: product_id
                        },
                        success: function (response) {

                            $('#notes_'+ product_id).empty();
                            $('#notes_'+ product_id).append(response);

                        }
                    });

                    $('#search_panels_container_'+ product_id).show();
                    $('#details_'+ product_id).slideUp(700);
                    $('#lists_'+ product_id).slideUp(700);
                    $('#track_'+ product_id).slideUp(700);
                    $('#reviews_'+ product_id).slideUp(700);
                    $('#notes_'+ product_id).slideDown(700);
                    $('#btn_details_'+ product_id).removeClass('active');
                    $('#btn_lists_'+ product_id).removeClass('active');
                    $('#btn_track_'+ product_id).removeClass('active');
                    $('#btn_notes_'+ product_id).addClass('active');
                    $('#btn_reviews_'+ product_id).removeClass('active');
                }
            });
            $.ajax({
                async: "true",
                url: "{{ path('clinic_get_product_notes') }}",
                type: 'POST',
                cache: false,
                timeout: 600000,
                dataType: 'json',
                data: {
                    product_id: product_id
                },
                success: function (response) {

                    if(response){
                        $('#product_notes_label_'+ product_id).append('<a class="note-link" id="note_link_'+ product_id +'" href=""><i class="fa-solid fa-pen-to-square"></i> <b>Notes From '+ response.from +':</b> '+ response.note +'</a>');
                        $('#'+ product_id).removeClass('hidden_msg');
                    }
                }
            });
            $(document).on('submit', '.form_note', function (e){

                product_id = $(this).data('product-id');

                e.preventDefault();

                let note = $('#note_'+ product_id).val();
                let note_error = $('#error_note_'+ product_id);
                let data = new FormData(this);
                let is_valid = true;

                note_error.hide()

                if(note == '' || note == 'undefined'){

                    note_error.show();
                    is_valid = false;
                }

                if(is_valid) {

                    $.ajax({
                        async: "true",
                        url: "{{ path('inventory_manage_note') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        beforeSend: function () {

                            isLoading(true);
                        },
                        success: function (response) {
                            $('#notes_'+ product_id).empty().append(response);

                            $.ajax({
                                async: "true",
                                url: "{{ path('clinic_get_product_notes') }}",
                                type: 'POST',
                                cache: false,
                                timeout: 600000,
                                dataType: 'json',
                                data: {
                                    product_id: ''+ product_id
                                },
                                success: function (response) {

                                    if(response){

                                        getNoteCount(response.note_count, product_id);

                                        $('#product_notes_label_'+ product_id).empty().append('<i class="fa-solid fa-pen-to-square"></i> <b>Notes From '+ response.from +':</b> '+ response.note);
                                        $('#product_notes_label_'+ product_id).removeClass('hidden_msg');

                                    } else {
                                        $('#product_notes_label_'+ product_id).addClass('hidden_msg');
                                    }

                                    isLoading(false);
                                }
                            });
                        }
                    });
                }
            });
            $(document).on('click', '.note_update', function (e){

                e.preventDefault();

                let note_id = $(this).data("id")

                $.ajax({
                    async: "true",
                    url: "{{ path('inventory_get_note') }}",
                    type: 'POST',
                    cache: false,
                    timeout: 600000,
                    dataType: 'json',
                    data: {
                        id: note_id
                    },
                    success: function (response) {
                        $('#note_create_new_'+ response.product_id).empty().append('<i class="fa-solid fa-circle-plus"></i> &nbsp;UPDATE NOTE');
                        $('#note_id_'+ response.product_id).val(note_id);
                        $('#note_'+ response.product_id).empty().val(response.note);
                    }
                });
            });
            $(document).on('click', '#delete_note', function (e){

                e.preventDefault();

                $.ajax({
                    async: "true",
                    url: "{{ path('inventory_manage_note') }}",
                    type: 'POST',
                    cache: false,
                    timeout: 600000,
                    dataType: 'json',
                    data: {
                        delete_id: true,
                        note_id: note_id,
                        product_id: product_id
                    },
                    success: function (response) {
                        $('#notes_'+ product_id).empty().append(response);
                        $('.modal-backdrop').removeClass('modal-backdrop');

                        $.ajax({
                            async: "true",
                            url: "{{ path('clinic_get_product_notes') }}",
                            type: 'POST',
                            cache: false,
                            timeout: 600000,
                            dataType: 'json',
                            data: {
                                product_id: product_id
                            },
                            success: function (response) {

                                if(response){

                                    getNoteCount(response.note_count, product_id);

                                    $('#product_notes_label_'+ product_id).empty().append('<i class="fa-solid fa-pen-to-square"></i> <b>Notes From '+ response.from +':</b> '+ response.note);
                                    $('#product_notes_label_'+ product_id).removeClass('hidden_msg');

                                } else {

                                    getNoteCount(0, product_id);

                                    $('#product_notes_label_'+ product_id).addClass('hidden_msg');
                                }
                            }
                        });
                    }
                });
            });
            $(document).on('click', '.delete-icon', function (e){

                e.preventDefault();

                note_id = $(this).data("note-id");
                product_id = $(this).data("product-id");

                $('#delete_note').attr('data-delete-note-id', note_id);
                $('#delete_note').attr('data-delete-product-id', product_id);

            });
            {# End Notes #}

            {# Reviews #}
            $(document).on('click', '#star-over-1', function (){
                $('#rating').val(0);
                $('#star-over-1').fadeOut(700);
                $('#star-over-2').fadeOut(700);
                $('#star-over-3').fadeOut(700);
                $('#star-over-4').fadeOut(700);
                $('#star-over-5').fadeOut(700);
            });
            $(document).on('click', '#star-under-1', function (){
                $('#rating').val(1);
                $('#star-over-1').fadeIn(700);
                $('#star-over-2').fadeOut(700);
                $('#star-over-3').fadeOut(700);
                $('#star-over-4').fadeOut(700);
                $('#star-over-5').fadeOut(700);
            });
            $(document).on('click', '#star-under-2', function (){
                $('#rating').val(2);
                $('#star-over-1').fadeIn(700);
                $('#star-over-2').fadeIn(700);
                $('#star-over-3').fadeOut(700);
                $('#star-over-4').fadeOut(700);
                $('#star-over-5').fadeOut(700);
            });
            $(document).on('click', '#star-over-2', function (){
                $('#rating').val(1);
                $('#star-over-2').fadeOut(700);
                $('#star-over-3').fadeOut(700);
                $('#star-over-4').fadeOut(700);
                $('#star-over-5').fadeOut(700);
            });
            $(document).on('click', '#star-under-3', function (){
                $('#rating').val(3);
                $('#star-over-1').fadeIn(700);
                $('#star-over-2').fadeIn(700);
                $('#star-over-3').fadeIn(700);
                $('#star-over-4').fadeOut(700);
                $('#star-over-5').fadeOut(700);
            });
            $(document).on('click', '#star-over-3', function (){
                $('#rating').val(2);
                $('#star-over-1').fadeIn(700);
                $('#star-over-2').fadeIn(700);
                $('#star-over-3').fadeOut(700);
                $('#star-over-4').fadeOut(700);
                $('#star-over-5').fadeOut(700);
            });
            $(document).on('click', '#star-under-4', function (){
                $('#rating').val(4);
                $('#star-over-1').fadeIn(700);
                $('#star-over-2').fadeIn(700);
                $('#star-over-3').fadeIn(700);
                $('#star-over-4').fadeIn(700);
                $('#star-over-5').fadeOut(700);
            });
            $(document).on('click', '#star-over-4', function (){
                $('#rating').val(3);
                $('#star-over-1').fadeIn(700);
                $('#star-over-2').fadeIn(700);
                $('#star-over-3').fadeIn(700);
                $('#star-over-4').fadeOut(700);
                $('#star-over-5').fadeOut(700);
            });
            $(document).on('click', '#star-under-5', function (){
                $('#rating').val(5);
                $('#star-over-1').fadeIn(700);
                $('#star-over-2').fadeIn(700);
                $('#star-over-3').fadeIn(700);
                $('#star-over-4').fadeIn(700);
                $('#star-over-5').fadeIn(700);
            });
            $(document).on('click', '#star-over-5', function (){
                $('#rating').val(4);
                $('#star-over-1').fadeIn(700);
                $('#star-over-2').fadeIn(700);
                $('#star-over-3').fadeIn(700);
                $('#star-over-4').fadeIn(700);
                $('#star-over-5').fadeOut(700);
            });
            $(document).on('click', '.btn_reviews', function(){

                product_id = $(this).data('product-id');

                if($('#reviews_'+ product_id +':visible').length) {

                    $('#reviews_'+ product_id).slideUp(700);
                    $('#search_panels_container_'+ product_id).slideUp(700);
                    $('#btn_reviews_'+ product_id).removeClass('active').removeClass('active');

                } else {

                    $('#search_panels_container_'+ product_id).show();
                    $('#details_'+ product_id).slideUp(700);
                    $('#lists_'+ product_id).slideUp(700);
                    $('#track_'+ product_id).slideUp(700);
                    $('#notes_'+ product_id).slideUp(700);
                    $('#reviews_'+ product_id).slideDown(700);
                    $('#basket_container').css({overflow:'auto'});
                    $('#btn_details_'+ product_id).removeClass('active');
                    $('#btn_lists_'+ product_id).removeClass('active');
                    $('#btn_track_'+ product_id).removeClass('active');
                    $('#btn_notes_'+ product_id).removeClass('active');
                    $('#btn_reviews_'+ product_id).addClass('active');

                    $.ajax({
                        async: "true",
                        url: '/clinics/get-review-details/'+ product_id,
                        type: 'GET',
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        success: function (response) {
                            $('#reviews_'+ product_id).empty().append(response.response);
                            $('#review_details_container').removeClass('half-border');
                        }
                    });
                }
            });
            $(document).on('click', '.btn_create_review', function (){

                $('#review_product_id').val($(this).data("product-id"))

                if($('.btn_create_review').length == 1)
                {
                    $(this).attr('data-bs-target','modal_review_all');
                    $('#modal_review_all').modal('toggle');
                }
            });
            $(document).on('click', '.review-like', function (e){

                e.preventDefault();

                let review_id = $(this).data('review-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('like_review') }}",
                    type: 'POST',
                    data: {
                        review_id: review_id
                    },
                    success: function (response) {

                        $('#like_'+ review_id).empty().append(response)
                    }
                });
            });
            $(document).on('submit', '#form_review', function (e){

                e.preventDefault();

                let rating = $('#rating').val();
                let review = $('#review').val();
                let error_rating = $('#error_rating');
                let error_review = $('#error_review');
                let data = new FormData(this);
                let is_valid = true;

                error_rating.hide();
                error_review.hide();

                if(rating == 0 || rating == 'undefined' || rating == ''){

                    error_rating.show();
                    is_valid = false;
                }

                if(review == '' || review == 'undefined'){

                    error_review.show();
                    is_valid = false;
                }

                if(is_valid) {

                    $.ajax({
                        async: "true",
                        url: "{{ path('create_review') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        beforeSend: function () {

                            isLoading(true);
                        },
                        success: function (response) {

                            getFlash(response);
                            $('#modal_review').modal('toggle');

                            let product_id = $('#review_product_id').val();

                            $.ajax({
                                async: "true",
                                url: '/clinics/get-reviews/'+ product_id,
                                type: 'POST',
                                cache: false,
                                timeout: 600000,
                                dataType: 'json',
                                data: {
                                    product_id: product_id
                                },
                                success: function (response) {

                                    if(response.review_count > 0) {

                                        rateStyle(response.review_average, 'parent_'+ product_id);
                                        $('#review_count_'+ product_id).empty().append('<p>(' + response.review_count + ' Reviews)</p>');
                                    }

                                    $.ajax({
                                        async: "true",
                                        url: '/clinics/get-review-details/'+ product_id,
                                        type: 'GET',
                                        cache: false,
                                        timeout: 600000,
                                        dataType: 'json',
                                        success: function (response) {
                                            if(response != false) {
                                                $('#reviews_'+ product_id).empty().append(response.response).show();
                                                isLoading(false);
                                            }
                                        }
                                    });

                                    $('#review_title').val('');
                                    $('#review').val('');
                                    $('#review_username').val('');
                                    $('#review_position').val('');
                                    $('#star-over-1').hide();
                                    $('#star-over-2').hide();
                                    $('#star-over-3').hide();
                                    $('#star-over-4').hide();
                                    $('#star-over-5').hide();
                                }
                            });

                            $('body').css(overflow,'');
                        }
                    });
                }
            });
            $(document).on('click', '.btn-comment', function (e){

                e.preventDefault();

                $('.hidden_msg').hide();

                let review_id = $(this).data('review-id');

                $('#leave_comment_container_'+ review_id).slideUp(700);

                if($('#comment_container_'+ review_id +':visible').length) {

                    $('#comment_icon_'+ review_id).removeClass('text-secondary');
                    $('#comment_span_'+ review_id).removeClass('text-secondary');
                    $('.review-comments-row').removeClass('mb-3');
                    $('#comment_container_'+ review_id).slideUp(700);

                } else {

                    $('.comment-container').slideUp(700);
                    $('#comment_icon_'+ review_id).addClass('text-secondary');
                    $('#comment_span_'+ review_id).addClass('text-secondary');
                    $('.review-comments-row').addClass('mb-3');
                    $('#comment_container_'+ review_id).slideDown(700);
                }
            });
            $(document).on('click', '.btn-leave-comment', function (e){

                e.preventDefault();

                $('.hidden_msg').hide();

                let review_id = $(this).data('review-id');

                $('#comment_container_'+ review_id).slideUp(700);

                if($('#leave_comment_container_'+ review_id +':visible').length) {

                    $('#leave_comment_icon_'+ review_id).removeClass('text-secondary');
                    $('#leave_comment_span_'+ review_id).removeClass('text-secondary');
                    $('.review-comments-row').removeClass('mb-3');
                    $('#leave_comment_container_'+ review_id).slideUp(700);

                } else {

                    $('.comment-container').slideUp(700);
                    $('#leave_comment_icon_'+ review_id).addClass('text-secondary');
                    $('#leave_comment_span_'+ review_id).addClass('text-secondary');
                    $('.review-comments-row').addClass('mb-3');
                    $('#leave_comment_container_'+ review_id).slideDown(700);
                }
            });
            $(document).on('submit', '.form-comment', function (e){

                let review_id = $(this).data('review-id');

                e.preventDefault();

                let comment = $('#comment_'+ review_id).val();
                let comment_error = $('#error_comment_'+ review_id);
                let data = new FormData(this);
                let is_valid = true;

                comment_error.hide()

                if(comment == '' || comment == 'undefined'){

                    comment_error.show();
                    is_valid = false;
                }

                if(is_valid) {

                    $.ajax({
                        async: "true",
                        url: "{{ path('inventory_manage_comment') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        beforeSend: function () {

                            isLoading(true);
                        } ,
                        success: function (response) {

                            $('#review_comments_'+ review_id).empty().append(response);
                            $('#comment_'+ review_id).val('');

                            $.ajax({
                                async: "true",
                                url: "{{ path('get_comment_count') }}",
                                type: 'POST',
                                dataType: 'json',
                                data: {
                                    review_id: review_id
                                },
                                success: function (response) {

                                    $('#comment_span_'+ review_id).empty().append('Comments'+ response);
                                    $('#comment_'+ review_id).val('');
                                    $('#leave_comment_container_'+ review_id).slideUp(700);
                                    $('#comment_container_'+ review_id).slideDown(700);
                                    isLoading(false);
                                }
                            });
                        }
                    });
                }
            });
            $(document).on('click', '.btn-view-all-reviews', function (e){

                e.preventDefault();

                let product_id = $(this).data('product-id');

                $.ajax({
                    async: "true",
                    url: '/clinics/get-review-details/'+ product_id,
                    type: 'POST',
                    data: {
                        product_id: product_id
                    },
                    success: function (response) {

                        getBackButton();
                        $('#inventory').empty().hide();
                        $('#inventory_container').hide();
                        $('.review_panel').empty();
                        $('#basket_container').empty().append(response.response).addClass('bg-light border-xy').css({overflow:''}).show();
                        $('.recent-reviews').empty().append('Showing All Reviews For '+ response.product_name);
                        $('.btn-view-all-reviews').hide();
                        $('#review_details_container').addClass('half-border');
                        window.scrollTo(0,0);
                    }
                });
            });
            {# End Reviews #}

            {# Basket Panels #}
            $(document).on('click','.basket_link', function (e){

                e.preventDefault();
                hidePaginator();
                $('.btn-basket-panel-active').removeClass('btn-basket-panel-active');
                $('.btn_item_facts').addClass('btn-basket-panel-active');

                distributor_id = $(this).data('distributor-id');
                product_id = $(this).data('product-id');

                $('#error_stock_'+ product_id +'_'+ distributor_id).empty();
                $('#qty_'+ product_id +'_'+ distributor_id).val(1);
                $('#panel_item_facts_'+ product_id +'_'+ distributor_id).show();
                $('#btn_item_facts_'+ product_id +'_'+ distributor_id).addClass('btn-basket-panel-active');
                $('#panel_shipping_'+ product_id +'_'+ distributor_id).hide();
                $('#panel_taxes_'+ product_id +'_'+ distributor_id).hide();

                if($(this).data('basket-id') == 'undefined') {

                    getBasket($(this).data('basket-id'), true);
                }
            });

            {# Item Facts #}
            $(document).on('click', '.btn_item_facts', function(e){

                e.preventDefault();

                $('.btn-basket-panel-active').removeClass('btn-basket-panel-active');

                if($('#panel_item_facts_'+ product_id +'_'+ distributor_id +':visible').length) {

                    $('#panel_item_facts_'+ product_id +'_'+ distributor_id).hide(700);
                    $('#panel_shipping_'+ product_id +'_'+ distributor_id).hide(700);
                    $('#panel_taxes_'+ product_id +'_'+ distributor_id).hide(700);

                } else {

                    $('#panel_item_facts_'+ product_id +'_'+ distributor_id).show(700);
                    $('#panel_shipping_'+ product_id +'_'+ distributor_id).hide(700);
                    $('#panel_taxes_'+ product_id +'_'+ distributor_id).hide(700);
                    $('.btn_item_facts').addClass('btn-basket-panel-active');
                }
            });

            {# Shipping #}
            $(document).on('click', '.btn_shipping', function(e){

                e.preventDefault();

                $('.btn-basket-panel-active').removeClass('btn-basket-panel-active');

                if($('#panel_shipping_'+ product_id +'_'+ distributor_id +':visible').length) {

                    $('#panel_item_facts_'+ product_id +'_'+ distributor_id).hide(700);
                    $('#panel_shipping_'+ product_id +'_'+ distributor_id).show(700);
                    $('#panel_taxes_'+ product_id +'_'+ distributor_id).hide(700);


                } else {

                    $('#panel_item_facts_'+ product_id +'_'+ distributor_id).hide(700);
                    $('#panel_shipping_'+ product_id +'_'+ distributor_id).show(700);
                    $('#panel_taxes_'+ product_id +'_'+ distributor_id).hide(700);
                    $('.btn_shipping').addClass('btn-basket-panel-active');
                }
            });

            {# Taxes #}
            $(document).on('click', '.btn_taxes', function(e){

                e.preventDefault();

                $('.btn-basket-panel-active').removeClass('btn-basket-panel-active');

                if($('#panel_taxes_'+ product_id +'_'+ distributor_id +':visible').length) {

                    $('#panel_item_facts_'+ product_id +'_'+ distributor_id).hide(700);
                    $('#panel_shipping_'+ product_id +'_'+ distributor_id).hide(700);
                    $('#panel_taxes_'+ product_id +'_'+ distributor_id).show(700);


                } else {

                    $('#panel_item_facts_'+ product_id +'_'+ distributor_id).hide(700);
                    $('#panel_shipping_'+ product_id +'_'+ distributor_id).hide(700);
                    $('#panel_taxes_'+ product_id +'_'+ distributor_id).show(700);
                    $('.btn_taxes').addClass('btn-basket-panel-active');
                }
            });
            {# End Basket Panels #}

            $(document).on('change', '#qty', function (){

                if($('#qty').val() == 'Enter Quantity') {

                    $('#qty').val('');
                }
            });

            {# Analytics #}
            function getAnalytics(){

                $('#back_btn').remove();
                $('#inventory_container').hide();
                $('#basket_container').show();
                isLoading(true);
                $("#basket_container").load('{{ path('get_clinic_charts') }}');
                isLoading(false);
                window.history.pushState(null, "Fluid", '/clinics/analytics');
            }
            $('#analytics_link').click(function (e) {

                e.preventDefault();
                getAnalytics();
                hidePaginator();

            });
            {# Ebd Analytics #}

            {# Account & Settings #}
            {# Company Information #}
            function getAccountSettings(){

                let search = $('#inventory').html();
                $('#back_btn').remove();

                $.ajax({
                    async: "true",
                    url: '{{ path('get_company_information') }}',
                    type: 'GET',
                    cache: false,
                    timeout: 600000,
                    dataType: 'json',
                    data: {
                        permissions: '{{ permissions|json_encode }}'
                    },
                    beforeSend: function (){

                        isLoading(true)
                    },
                    complete: function(e){
                        if(e.status === 500){
                            window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                    success: function (response) {

                        getBackButton();
                        $('#inventory_container').hide();
                        $('#inventory').hide();
                        $('#main_container')
                        $('#basket_container').empty().removeClass('col-container').append(response).show();
                        window.scrollTo(0,0);
                        clearInterval(get_messages);
                        isLoading(false);
                        window.history.pushState(null, "Fluid", '/clinics/account');

                        // International Numbers
                        let input = document.querySelector('#mobile');
                        let isoCode = $('#isocode').val();

                        iti = window.intlTelInput(input, {
                            initialCountry: isoCode,
                            preferredCountries: ['ae','qa', 'bh', 'om', 'sa'],
                            autoPlaceholder: "polite",
                            nationalMode: true,
                            utilsScript: "{{ asset('js/utils.min.js') }}", // just for formatting/placeholders etc
                            separateDialCode: true,
                            utilsScript: "/js/utils.js",
                        });

                        let handleChange = function() {
                            let mobile = $('#clinic_telephone');
                            let mobile_number = (iti.isValidNumber()) ? iti.getNumber() : false;
                            let textNode = document.createTextNode(mobile_number);

                            if(mobile_number != false){

                                mobile.val(mobile_number.substring(1));
                            }
                        };

                        // listen to "keyup", but also "change" to update when the user selects a country
                        input.addEventListener('change', handleChange);
                        input.addEventListener('keyup', handleChange);
                    }
                });
            }
            $('#account_settings_link').click(function (e) {

                e.preventDefault();
                getAccountSettings();
                hidePaginator();

            });
            $(document).on('submit','#form_clinic_information',function(e){

                e.preventDefault();

                let isValid = true;
                let clinicName = $('#clinic_name').val()
                let clinicEmail = $('#clinic_email').val();
                let clinicTelephone = $('#clinic_telephone').val();
                let managerFirstName = $('#manager_first_name').val();
                let managerLastName = $('#manager_last_name').val();
                let managerIdNo = $('#manager_id_no').val();
                let managerIdExpDate = $('#manager_id_exp_date').val();
                let tradeLicenseFile = $('#trade_license_file').val();
                let tradeLicenseNo = $('#trade_license_no').val();
                let tradeLicenseExpDate = $('#trade_license_exp_date').val();
                let errorClinicName = $('#error_clinic_name');
                let errorClinicEmail = $('#error_clinic_email');
                let errorClinicTelephone = $('#error_clinic_telephone');
                let errorManagerFirstName = $('#error_manager_first_name');
                let errorManagerLastName = $('#error_manager_last_name');
                let errorManagerIdNo = $('#error_manager_id_no');
                let errorManagerIdExpDate = $('#error_manager_id_exp_date');
                let errorTradeLicenseFile = $('#error_trade_license_file');
                let errorTradeLicenseNo = $('#error_trade_license_no');
                let errorTradeLicenseExpDate = $('#error_trade_license_exp_date');
                let isTradeLicense = '{{ clinic.tradeLicense }}' ? '{{ clinic.tradeLicense }}' : false;

                errorClinicName.hide();
                errorClinicEmail.hide();
                errorClinicTelephone.hide();
                errorManagerFirstName.hide();
                errorManagerLastName.hide();
                errorManagerIdNo.hide();
                errorManagerIdExpDate.hide();
                errorTradeLicenseNo.hide();
                errorTradeLicenseExpDate.hide();

                if(isTradeLicense)
                {
                    errorTradeLicenseFile.hide();
                }

                if(clinicName == '' || clinicName == 'undefined')
                {
                    errorClinicName.show();
                    isValid = false;
                }

                if(clinicEmail == '' || clinicEmail == 'undefined')
                {
                    errorClinicEmail.show();
                    isValid = false;
                }

                if(clinicTelephone == '' || clinicTelephone == 'undefined')
                {
                    errorClinicTelephone.show();
                    isValid = false;
                }

                if(managerFirstName == '' || managerFirstName == 'undefined')
                {
                    errorManagerFirstName.show();
                    isValid = false;
                }

                if(managerLastName == '' || managerLastName == 'undefined')
                {
                    errorManagerLastName.show();
                    isValid = false;
                }

                if(managerIdNo == '' || managerIdNo == 'undefined')
                {
                    errorManagerIdNo.show();
                    isValid = false;
                }

                if(managerIdExpDate == '' || managerIdExpDate == 'undefined')
                {
                    errorManagerIdExpDate.show();
                    isValid = false;
                }

                if((tradeLicenseFile == '' || tradeLicenseFile == 'undefined') && !isTradeLicense)
                {
                    errorTradeLicenseFile.show();
                    isValid = false;
                }

                if(tradeLicenseNo == '' || tradeLicenseNo == 'undefined')
                {
                    errorTradeLicenseNo.show();
                    isValid = false;
                }

                if(tradeLicenseExpDate == '' || tradeLicenseExpDate == 'undefined')
                {
                    errorTradeLicenseExpDate.show();
                    isValid = false;
                }

                if(isValid == true)
                {
                    let iso = iti.getSelectedCountryData().iso2;
                    let intlCode = iti.getSelectedCountryData().dialCode

                    $('<input />').attr('type', 'hidden').attr('name', 'clinic_form[iso-code]')
                        .attr('value', iso).appendTo('#form_clinic_information');
                    $('<input />').attr('type', 'hidden').attr('name', 'clinic_form[intl-code]')
                        .attr('value', intlCode).appendTo('#form_clinic_information');

                    let data = new FormData(this);

                    $.ajax({
                        async: "true",
                        url: "{{ path('clinic_update_company_information') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        beforeSend: function ()
                        {
                            isLoading(true);
                        },
                        success: function (response)
                        {
                            getFlash(response);
                            isLoading(false);

                            if(tradeLicenseFile != '')
                            {
                                location.reload(true);
                            }
                        }
                    });
                }
            });
            $(document).on('change', '#trade_license_file', function() {

                let fp = $("#trade_license_file");
                let lg = fp[0].files.length; // get length
                let items = fp[0].files;
                let errorTradeLicense = $('#error_trade_license_file');
                let fileName = '';
                let fileSize = '';
                let fileType = '';

                errorTradeLicense.hide().append('Required Field');

                if (lg > 0) {
                    for (let i = 0; i < lg; i++) {
                        fileName = items[i].name; // get file name
                        fileSize = items[i].size; // get file size
                        fileType = items[i].type; // get file type
                    }
                }

                if(fileType != 'application/pdf')
                {
                    fp.val('');
                    errorTradeLicense.empty().append('Please select a PDF document').show();
                }
            });
            $(document).on('click', '#company_information_tab', function ()
            {
                $('.active').removeClass('active');
                $('#company_information_tab').find('span:first-child').addClass('active');
                $('#company_information_panel').slideDown(700);
                $('#about_panel').slideUp(700);
                $('#operating_hours_panel').slideUp(700);
                $('#refund_policy_panel').slideUp(700);
                $('#sales_tax_policy_panel').slideUp(700);
                $('#shipping_policy_panel').slideUp(700);
            });

            {# About #}
            $(document).on('click', '#about_tab', function ()
            {
                $('.active').removeClass('active');
                $('#about_tab').find('span:first-child').addClass('active');
                $('#company_information_panel').slideUp(700);
                $('#about_panel').slideDown(700);
                $('#operating_hours_panel').slideUp(700);
                $('#refund_policy_panel').slideUp(700);
                $('#sales_tax_policy_panel').slideUp(700);
                $('#shipping_policy_panel').slideUp(700);

                iniTinyMce();
            });
            $(document).on('submit', '#form_about', function (e)
            {
                e.preventDefault();

                let about = $('#about_copy').val();
                let errorAbout = $('#error_about_copy');
                let isValid = true;
                let data = new FormData(this);

                errorAbout.hide();

                if(about == '' || about == 'undefined')
                {
                    errorAbout.show();
                    isValid = false;
                }

                if(isValid)
                {
                    $.ajax({
                        async: "true",
                        url: "{{ path('clinic_update_copy') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        beforeSend: function ()
                        {
                            isLoading(true);
                        },
                        complete: function(e)
                        {
                            if(e.status === 500)
                            {
                                window.location.href = '{{ path('clinic_error_500') }}';
                            }
                        },
                        success: function (response)
                        {
                            isLoading(false);
                            getFlash(response.flash);
                        }
                    });
                }
            })

            {# Operating Hours #}
            $(document).on('click', '#operating_hours_tab', function ()
            {
                $('.active').removeClass('active');
                $('#operating_hours_tab').find('span:first-child').addClass('active');
                $('#company_information_panel').slideUp(700);
                $('#about_panel').slideUp(700);
                $('#operating_hours_panel').slideDown(700);
                $('#refund_policy_panel').slideUp(700);
                $('#sales_tax_policy_panel').slideUp(700);
                $('#shipping_policy_panel').slideUp(700);

                iniTinyMce();
            });
            $(document).on('submit', '#form_operating_hours', function (e)
            {
                e.preventDefault();

                let operatingHours = $('#operating_hours_copy').val();
                let errorOperatingHours = $('#error_operating_hours_copy');
                let isValid = true;
                let data = new FormData(this);

                errorOperatingHours.hide();

                if(operatingHours == '' || operatingHours == 'undefined')
                {
                    errorOperatingHours.show();
                    isValid = false;
                }

                if(isValid)
                {
                    $.ajax({
                        async: "true",
                        url: "{{ path('clinic_update_copy') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        beforeSend: function ()
                        {
                            isLoading(true);
                        },
                        complete: function(e)
                        {
                            if(e.status === 500)
                            {
                                window.location.href = '{{ path('clinic_error_500') }}';
                            }
                        },
                        success: function (response)
                        {
                            isLoading(false);
                            getFlash(response.flash);
                        }
                    });
                }
            })

            {# Refund Policy #}
            $(document).on('click', '#refund_policy_tab', function ()
            {
                $('.active').removeClass('active');
                $('#refund_policy_tab').find('span:first-child').addClass('active');
                $('#company_information_panel').slideUp(700);
                $('#about_panel').slideUp(700);
                $('#operating_hours_panel').slideUp(700);
                $('#refund_policy_panel').slideDown(700);
                $('#sales_tax_policy_panel').slideUp(700);
                $('#shipping_policy_panel').slideUp(700);

                iniTinyMce();
            });
            $(document).on('submit', '#form_refund_policy', function (e)
            {
                e.preventDefault();

                let refundPolicy = $('#refund_policy_copy').val();
                let errorRefundPolicy = $('#error_refund_policy_copy');
                let isValid = true;
                let data = new FormData(this);

                errorRefundPolicy.hide();

                if(refundPolicy == '' || refundPolicy == 'undefined')
                {
                    errorRefundPolicy.show();
                    isValid = false;
                }

                if(isValid)
                {
                    $.ajax({
                        async: "true",
                        url: "{{ path('clinic_update_copy') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        beforeSend: function ()
                        {
                            isLoading(true);
                        },
                        complete: function(e)
                        {
                            if(e.status === 500)
                            {
                                window.location.href = '{{ path('clinic_error_500') }}';
                            }
                        },
                        success: function (response)
                        {
                            isLoading(false);
                            getFlash(response.flash);
                        }
                    });
                }
            })

            {# Sales Policy #}
            $(document).on('click', '#sales_tax_policy_tab', function ()
            {
                $('.active').removeClass('active');
                $('#sales_tax_policy_tab').find('span:first-child').addClass('active');
                $('#company_information_panel').slideUp(700);
                $('#about_panel').slideUp(700);
                $('#operating_hours_panel').slideUp(700);
                $('#refund_policy_panel').slideUp(700);
                $('#sales_tax_policy_panel').slideDown(700);
                $('#shipping_policy_panel').slideUp(700);

                iniTinyMce();
            });
            $(document).on('submit', '#form_sales_tax_policy', function (e)
            {
                e.preventDefault();

                let salesTaxPolicy = $('#sales_tax_policy_copy').val();
                let errorSalesTaxPolicy = $('#error_sales_tax_policy_copy');
                let isValid = true;
                let data = new FormData(this);

                errorSalesTaxPolicy.hide();

                if(salesTaxPolicy == '' || salesTaxPolicy == 'undefined')
                {
                    errorSalesTaxPolicy.show();
                    isValid = false;
                }

                if(isValid)
                {
                    $.ajax({
                        async: "true",
                        url: "{{ path('clinic_update_copy') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        beforeSend: function ()
                        {
                            isLoading(true);
                        },
                        complete: function(e)
                        {
                            if(e.status === 500)
                            {
                                window.location.href = '{{ path('clinic_error_500') }}';
                            }
                        },
                        success: function (response)
                        {
                            isLoading(false);
                            getFlash(response.flash);
                        }
                    });
                }
            })

            {# Shipping Policy #}
            $(document).on('click', '#shipping_policy_tab', function ()
            {
                $('.active').removeClass('active');
                $('#shipping_policy_tab').find('span:first-child').addClass('active');
                $('#company_information_panel').slideUp(700);
                $('#about_panel').slideUp(700);
                $('#operating_hours_panel').slideUp(700);
                $('#refund_policy_panel').slideUp(700);
                $('#sales_tax_policy_panel').slideUp(700);
                $('#shipping_policy_panel').slideDown(700);

                iniTinyMce();
            });
            $(document).on('submit', '#form_shipping_policy', function (e)
            {
                e.preventDefault();

                let shippingPolicy = $('#shipping_policy_copy').val();
                let errorShippingPolicy = $('#error_shipping_policy_copy');
                let isValid = true;
                let data = new FormData(this);

                errorShippingPolicy.hide();

                if(shippingPolicy == '' || shippingPolicy == 'undefined')
                {
                    errorShippingPolicy.show();
                    isValid = false;
                }

                if(isValid)
                {
                    $.ajax({
                        async: "true",
                        url: "{{ path('clinic_update_copy') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        beforeSend: function ()
                        {
                            isLoading(true);
                        },
                        complete: function(e)
                        {
                            if(e.status === 500)
                            {
                                window.location.href = '{{ path('clinic_error_500') }}';
                            }
                        },
                        success: function (response)
                        {
                            isLoading(false);
                            getFlash(response.flash);
                        }
                    });
                }
            })

            function iniTinyMce()
            {
                tinymce.init({
                    selector: '.tinymce-selector',
                    plugins: 'preview importcss searchreplace autolink autosave save directionality code visualblocks visualchars fullscreen image link media template codesample table charmap pagebreak nonbreaking anchor insertdatetime advlist lists wordcount help charmap quickbars emoticons',
                    editimage_cors_hosts: ['picsum.photos'],
                    menubar: false,
                    toolbar: 'undo redo | bold italic underline strikethrough | fontsize blocks | alignleft aligncenter alignright alignjustify | outdent indent |  numlist bullist removeformat',
                    toolbar_sticky: false,
                    statusbar: false,
                    height: 300,
                    image_caption: true,
                    quickbars_selection_toolbar: 'bold italic | quicklink h2 h3 blockquote quickimage quicktable',
                    noneditable_class: 'mceNonEditable',
                    toolbar_mode: 'sliding',
                    contextmenu: 'link image table',
                    content_style: 'body { font-family:Helvetica,Arial,sans-serif; font-size:16px }'
                });

                $('.tox-notifications-container').remove();
            }
            {# End Account & Settings #}

            {# Users #}
            let user_telephone = '';
            function getUsers(page_id){

                let search = $('#inventory').html();
                $('#back_btn').remove();

                $.ajax({
                    async: "true",
                    url: '{{ path('get-clinic-users') }}',
                    type: 'POST',
                    cache: false,
                    timeout: 600000,
                    dataType: 'json',
                    data:{
                        page_id:page_id,
                        permissions: '{{ permissions|json_encode }}'
                    },
                    beforeSend: function (){

                        isLoading(true)
                    },
                    complete: function(e, xhr, settings){
                        if(e.status === 500){
                            window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                    success: function (response) {

                        getBackButton();
                        $('#inventory').hide();
                        $('#inventory_container').hide();
                        $('#basket_container').empty().removeClass('col-container').append(response.html).show();
                        $('#paginator').empty().append(response.pagination).show();
                        window.scrollTo(0,0);
                        clearInterval(get_messages);
                        isLoading(false);
                        window.history.pushState(null, "Fluid", '/clinics/users');
                        popOver();
                    }
                });
            }

            $('#users_link').click(function (e) {

                e.preventDefault();
                getUsers(1);

            });
            $(document).on('click', '.user-pagination', function (e){

                e.preventDefault();

                let page_id = $(this).data('page-id');

                getUsers(page_id);
            });
            $(document).on('click', '.open-user-modal', function () {

                $('#create_user').empty().append('UPDATE');
                let user_id = $(this).data('user-id');
                let page_id = $(this).data('page-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('clinic_get_user') }}",
                    type: 'POST',
                    data: {
                        id: user_id
                    },
                    success: function (response) {

                        $('#user_first_name').val(response.first_name);
                        $('#user_last_name').val(response.last_name);
                        $('#user_email').val(response.email);
                        $('#user_telephone').val(response.telephone);
                        $('#user_iso_code').val(response.iso_code);
                        $('#user_intl_code').val(response.intl_code);
                        $('#user_mobile').val(response.telephone);
                        $('#user_position').val(response.position);
                        $('#user_page_id').remove();
                        $('#form_users input[type="checkbox"]').attr('checked', false);

                        for(i = 0; i < response.permissions.length; i++){

                            $('#permission_'+ response.permissions[i]).attr('checked', true);
                        };

                        $("<input />")
                            .attr("type", "hidden")
                            .attr("name", "pageId")
                            .attr("value", page_id)
                            .attr("id", 'user_page_id')
                            .appendTo("#form_users");

                        user_telephone = response.telephone;
                        let input = document.querySelector("#user_mobile");

                        iti = window.intlTelInput(input, {
                            preferredCountries: ['ae','qa', 'bh', 'om', 'sa'],
                            initialCountry: response.iso_code,
                            autoPlaceholder: "polite",
                            nationalMode: true,
                            utilsScript: "{{ asset('js/utils.min.js') }}", // just for formatting/placeholders etc
                            separateDialCode: true,
                            utilsScript: "/js/utils.js",
                        });
                    }
                });

                $('#user_id').val(user_id);
                $('#user_modal_label').empty().append('Update a User');
            });
            $(document).on('blur','#user_mobile', function (){

                let input = document.querySelector("#user_mobile");

                let handleChange = function() {
                    let mobile = $('#user_telephone');
                    let mobile_number = (iti.isValidNumber()) ? iti.getNumber() : false;
                    let textNode = document.createTextNode(mobile_number);

                    if(mobile_number != false){

                        $('#user_telephone').val('');
                        $('#user_iso_code').val('');
                        $('#user_intl_code').val('');

                        isoCode = iti.getSelectedCountryData().iso2;
                        intlCode = iti.getSelectedCountryData().dialCode;

                        mobile.val(mobile_number.substring(1));
                        $('#user_iso_code').val(isoCode);
                        $('#user_intl_code').val(intlCode);

                    }
                };

                // listen to "keyup", but also "change" to update when the user selects a country
                input.addEventListener('change', handleChange);
                input.addEventListener('keyup', handleChange);
            });
            $(document).on('click','#user_new',function (){

                $('#create_user').empty().append('CREATE');
                $('#user_modal_label').empty().append('Create a User');
                $('#user_id').val(0);
                $('#user_first_name').val('');
                $('#user_last_name').val('');
                $('#user_email').val('');
                $('#user_telephone').val('');
                $('#user_mobile').val('');
                $('#user_position').val('');
                $('#form_users input[type="checkbox"]').attr('checked', false);

                let input = document.querySelector("#user_mobile");

                iti = window.intlTelInput(input, {
                    preferredCountries: ['ae','qa', 'bh', 'om', 'sa'],
                    initialCountry: 'za',
                    autoPlaceholder: "polite",
                    nationalMode: true,
                    utilsScript: "{{ asset('js/utils.min.js') }}", // just for formatting/placeholders etc
                    separateDialCode: true,
                    utilsScript: "/js/utils.js",
                });
            });
            $(document).on('submit','#form_users',function(e){

                e.preventDefault();

                let is_valid = true;
                let user_first_name = $('#user_first_name').val()
                let user_last_name = $('#user_last_name').val();
                let user_email = $('#user_email').val();
                let user_telephone = $('#user_telephone').val();
                let user_mobile = $('#user_mobile');
                let error_user_first_name = $('#error_user_first_name');
                let error_user_last_name = $('#error_user_last_name');
                let error_user_email = $('#error_user_email');
                let error_user_telephone = $('#error_user_telephone');

                error_user_first_name.hide();
                error_user_last_name.hide();
                error_user_email.hide();
                error_user_telephone.hide();

                if(user_first_name == '' || user_first_name == 'undefined'){

                    error_user_first_name.show();
                    is_valid = false;
                }

                if(user_last_name == '' || user_last_name == 'undefined'){

                    error_user_last_name.show();
                    is_valid = false;
                }

                if(user_email == '' || user_email == 'undefined'){

                    error_user_email.show();
                    is_valid = false;
                }

                if(user_telephone == '' || user_telephone == 'undefined'){

                    error_user_telephone.show();
                    user_mobile.val('');
                    is_valid = false;
                }

                if(is_valid == true){

                    $("<input />")
                        .attr("type", "hidden")
                        .attr("name", "clinic_users_form[isoCode]")
                        .attr("value", isoCode)
                        .attr("id", 'user_iso_code')
                        .appendTo("#form_users");

                    $("<input />")
                        .attr("type", "hidden")
                        .attr("name", "clinic_users_form[intlCode]")
                        .attr("value", intlCode)
                        .attr("id", 'user_intl_code')
                        .appendTo("#form_users");

                    let data = new FormData(this);

                    $('#create_user').empty().attr('disabled', true).append('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> PROCESSING...');

                    $.ajax({
                        async: "true",
                        url: "{{ path('clinic_get_users') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        complete: function(e, xhr, settings){
                            if(e.status === 500){
                                window.location.href = '{{ path('clinic_error_500') }}';
                            }
                        },
                        success: function (response) {

                            if (response.response) {

                                getFlash(response.message);
                                $('#modal_user').modal('toggle');
                                $('#modal_user').modal('hide');
                                $('.modal-backdrop').removeClass('modal-backdrop');
                                $('.fade').removeClass('fade');
                                $('#user_first_name').val('');
                                $('#user_last_name').val('');
                                $('#user_email').val('');
                                $('#user_telephone').val('');
                                $('#user_position').val('');
                                $('#create_user').empty().append('SAVE').attr('disabled', false);

                                getUsers(response.page_id);

                            } else {
                                $('#error_user_email').empty();
                                $('#error_user_email').append('Email address exists.');
                                $('#error_user_email').show();
                                $('#create_user').empty().append('SAVE').attr('disabled', false);
                            }
                        }
                    });
                }
            });
            $(document).on('click', '.open-delete-user-modal', function (e){

                e.preventDefault();

                $('#delete_user').attr('data-user-id', $(this).data('user-id'));
            });
            $(document).on('click', '#delete_user', function () {

                let user_id = $(this).data('user-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('clinic_user_delete') }}",
                    type: 'POST',
                    data: {
                        id: user_id
                    },
                    complete: function(e, xhr, settings){
                        if(e.status === 500){
                            window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                    success: function (response) {
                        $('#flash').addClass('alert-success');
                        $('#flash').removeClass('alert-danger');
                        $('#flash').addClass('alert');
                        $('#flash').addClass('text-center');
                        $('#flash').removeClass('users-flash');
                        $('#flash').addClass('users-flash');
                        $('#flash').empty();
                        $('#flash').append(response);
                        $('#flash').removeClass('hidden');
                        $('#modal_user_delete').modal('toggle');
                        $('#modal_user_delete').modal('hide');
                        $('.modal-backdrop').removeClass('modal-backdrop');
                        $('#modal_user_delete').addClass('fade');

                        $.ajax({
                            async: "true",
                            url: "{{ path('clinic_refresh_users') }}",
                            type: 'POST',
                            contentType: false,
                            processData: false,
                            cache: false,
                            timeout: 600000,
                            dataType: 'json',
                            success: function (response) {
                                $('#basket_container').empty().append(response);
                            }
                        });
                    }
                });
            });
            {# End Users #}

            {# Addresses #}
            function getAddresses(page_id){

                let page = $('html').html();
                $('#back_btn').remove();

                $.ajax({
                    async: "true",
                    url: '{{ path('get_clinic_addresses') }}',
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        page_id: page_id,
                        permissions: '{{ permissions|json_encode }}'
                    },
                    beforeSend: function (){

                        isLoading(true)
                    },
                    complete: function(e, xhr, settings){
                        if(e.status === 500){
                            window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                    success: function (response) {

                        getBackButton();
                        $('#inventory').hide();
                        $('#inventory_container').hide();
                        $('#basket_container').empty().removeClass('col-container').append(response.html).show();
                        $('#paginator').empty().append(response.pagination).show();
                        window.scrollTo(0,0);
                        clearInterval(get_messages);
                        isLoading(false);
                        window.history.pushState(null, "Fluid", '/clinics/addresses');
                    }
                });
            }

            $('#addresses_link').click(function (e) {

                e.preventDefault();

                getAddresses(1);
            });
            $(document).on('click', '.address-pagination', function (e){

                e.preventDefault();

                page_id = $(this).data('page-id');

                getAddresses(page_id);
            });
            $(document).on('click', '#address_new', function (){

                $('#address_id').val(0);
                $('#address_clinic_name').val('');
                $('#address_mobile').val('');
                $('#address_line_1').val('');
                $('#address_modal_label').empty().append('Create An Address');

                let input = document.querySelector("#address_mobile");

                iti = window.intlTelInput(input, {
                    initialCountry: "auto",
                    geoIpLookup: function(success, failure) {
                        $.get("https://ipinfo.io", function() {}, "jsonp").always(function(resp) {
                            var countryCode = (resp && resp.country) ? resp.country : "ae";
                            success(countryCode);
                        });
                    },
                    preferredCountries: ['ae','qa', 'bh', 'om', 'sa'],
                    autoPlaceholder: "polite",
                    nationalMode: true,
                    utilsScript: "{{ asset('js/utils.min.js') }}", // just for formatting/placeholders etc
                    separateDialCode: true,
                    utilsScript: "/js/utils.js",
                });
            });
            $(document).on('click', '.address_update', function () {

                let address_id = $(this).data('address-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('get_address') }}",
                    type: 'POST',
                    data: {
                        id: address_id
                    },
                    success: function (response) {
                        $('#address_clinic_name').val(response.clinic_name);
                        $('#address_telephone').val(response.telephone);
                        $('#address_mobile').val(response.telephone);
                        $('#address_iso_code').val(response.iso_code);
                        $('#address_intl_code').val(response.intl_code);
                        $('#address_line_1').val(response.address);
                        $('option').attr('selected', false);

                        if(response.type == 1){

                            $('#option_billing').attr('selected', true);
                        }

                        if(response.type == 2){

                            $('#option_shipping').attr('selected', true);
                        }

                        let input = document.querySelector("#address_mobile");

                        iti = window.intlTelInput(input, {
                            preferredCountries: ['ae','qa', 'bh', 'om', 'sa'],
                            initialCountry: response.iso_code,
                            autoPlaceholder: "polite",
                            nationalMode: true,
                            utilsScript: "{{ asset('js/utils.min.js') }}", // just for formatting/placeholders etc
                            separateDialCode: true,
                            utilsScript: "/js/utils.js",
                        });
                    }
                });

                $('#address_id').val(address_id);
                $('#address_modal_label').empty().append('Update An Address');
            });
            $(document).on('keyup','#address_mobile', function (){

                let input = document.querySelector("#address_mobile");

                $('#address_telephone').val('');
                $('#address_iso_code').val('');
                $('#address_intl_code').val('');

                let handleChange = function() {
                    let mobile = $('#address_telephone');
                    let mobile_number = (iti.isValidNumber()) ? iti.getNumber() : false;
                    let textNode = document.createTextNode(mobile_number);

                    if(mobile_number != false){

                        let isoCode = iti.getSelectedCountryData().iso2;
                        let intlCode = iti.getSelectedCountryData().dialCode;

                        mobile.val(mobile_number.substring(1));
                        $('#address_iso_code').val(isoCode);
                        $('#address_intl_code').val(intlCode);

                    }
                };

                // listen to "keyup", but also "change" to update when the user selects a country
                input.addEventListener('change', handleChange);
                input.addEventListener('keyup', handleChange);
            });
            $(document).on('click', '.open-delete-address-modal', function (e){

                e.preventDefault();

                $('#delete_address').attr('data-address-id', $(this).data('address-id'));
            });
            $(document).on('click', '#delete_address', function () {

                let address_id = $(this).data('address-id');
                let page_id = $('#page_no').val();

                $.ajax({
                    async: "true",
                    url: "{{ path('address_delete') }}",
                    type: 'POST',
                    data: {
                        id: address_id,
                        page_id: page_id
                    },
                    beforeSend: function (){
                        isLoading(true);
                    },
                    success: function (response) {
                        getFlash(response.flash);
                        $('#basket_container').empty().append(response.addresses);
                        $('#paginator').empty().append(response.pagination).show();
                        $('#modal_address_delete').modal('hide');
                        $('.modal-backdrop').removeClass('modal-backdrop');
                        $('#modal_address_delete').addClass('fade');
                        isLoading(false);
                    }
                });
            });
            $(document).on('click', '.address_default', function (e) {

                e.preventDefault();

                let address_id = $(this).data('address-id');
                let page_id = $('#page_no').val();

                $.ajax({
                    async: "true",
                    url: "{{ path('clinic_address_default') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        id: address_id,
                        page_id: page_id
                    },
                    beforeSend: function (){
                        isLoading(true);
                    },
                    success: function (response) {

                        getFlash(response.flash);
                        $('#basket_container').empty().append(response.addresses);
                        $('#paginator').empty().append(response.pagination).show();
                        isLoading(false);
                    }
                });
            });
            $(document).on('click', '.address_default_billing', function (e) {

                e.preventDefault();

                let address_id = $(this).data('billing-address-id');
                let page_id = $('#page_no').val();

                $.ajax({
                    async: "true",
                    url: "{{ path('clinic_billing_address_default') }}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        id: address_id,
                        page_id: page_id,
                    },
                    beforeSend: function (){
                      isLoading(true);
                    },
                    success: function (response) {

                        getFlash(response.flash);
                        $('#basket_container').empty().append(response.addresses);
                        $('#paginator').empty().append(response.pagination).show();
                        isLoading(false);
                    }
                });
            });
            $(document).on('submit', '#form_addresses', function(e){

                e.preventDefault();

                let is_valid = true;
                let clinic_name = $('#address_clinic_name').val()
                let telephone = $('#address_telephone').val();
                let address_line_1 = $('#address_line_1').val();
                let type = $('#address_type').val();
                let error_clinic_name = $('#error_address_clinic_name');
                let error_telephone = $('#error_address_telephone');
                let error_address_line_1 = $('#error_address_line_1');
                let error_type = $('#error_address_type');

                error_clinic_name.hide();
                error_telephone.hide();
                error_address_line_1.hide();
                error_type.hide();

                if(clinic_name == '' || clinic_name == 'undefined'){

                    error_clinic_name.show();
                    is_valid = false;
                }

                if(telephone == '' || telephone == 'undefined'){

                    error_telephone.show();
                    is_valid = false;
                }

                if(address_line_1 == '' || address_line_1 == 'undefined'){

                    error_address_line_1.show();
                    is_valid = false;
                }

                if(type == '' || type == 'undefined'){

                    error_type.show();
                    is_valid = false;
                }

                if(is_valid == true){

                    $("<input />").attr("type", "hidden").attr("name", "page_id").attr("value", $('#page_no').val()).appendTo("#form_addresses");

                    let data = new FormData(this);

                    $.ajax({
                        async: "true",
                        url: "{{ path('update_address') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        beforeSend: function (){
                          isLoading(true);
                        },
                        success: function (response) {
                            getFlash(response.flash);

                            $('#basket_container').empty().append(response.addresses);
                            $('#paginator').empty().append(response.pagination).show();
                            $('#modal_address').modal('hide');
                            $('.modal-backdrop').removeClass('modal-backdrop');
                            $('.fade').removeClass('fade');
                            isLoading(false);
                            $('#address_clinic_name').val('');
                            $('#address_telephone').val('');
                            $('#address_line_1').val('');
                            $('#address_suite').val('');
                            $('#address_postal_code').val('');
                            $('#address_city').val('');
                            $('#address_state').val('');
                        }
                    });
                }
            });
            $(document).on('submit', '#form_addresses_shipping_checkout', function(e){

                e.preventDefault();

                let data = new FormData(this);
                let address_id = data.get('address');

                if(address_id == null) {

                    let is_valid = true;
                    let clinic_name = $('#address_clinic_name').val()
                    let telephone = $('#address_telephone').val();
                    let address_line_1 = $('#address_line_1').val();
                    let postal_code = $('#address_postal_code').val();
                    let city = $('#address_city').val();
                    let state = $('#address_state').val();
                    let type = $('#address_type').val();
                    let error_clinic_name = $('#error_address_clinic_name');
                    let error_telephone = $('#error_address_telephone');
                    let error_address_line_1 = $('#error_address_line_1');
                    let error_postal_code = $('#error_address_postal_code');
                    let error_city = $('#error_address_city');
                    let error_state = $('#error_address_state');
                    let error_type = $('#error_address_type');

                    error_clinic_name.hide();
                    error_telephone.hide();
                    error_address_line_1.hide();
                    error_postal_code.hide();
                    error_city.hide();
                    error_state.hide();
                    error_type.hide();

                    if (clinic_name == '' || clinic_name == 'undefined') {

                        error_clinic_name.show();
                        is_valid = false;
                    }

                    if (telephone == '' || telephone == 'undefined') {

                        error_telephone.show();
                        is_valid = false;
                    }

                    if (address_line_1 == '' || address_line_1 == 'undefined') {

                        error_address_line_1.show();
                        is_valid = false;
                    }

                    if (city == '' || city == 'undefined') {

                        error_city.show();
                        is_valid = false;
                    }

                    if (postal_code == '' || postal_code == 'undefined') {

                        error_postal_code.show();
                        is_valid = false;
                    }

                    if (state == '' || state == 'undefined') {

                        error_state.show();
                        is_valid = false;
                    }

                    if (type == '' || type == 'undefined') {

                        error_type.show();
                        is_valid = false;
                    }

                    if (is_valid == true) {



                        $.ajax({
                            async: "true",
                            url: "{{ path('update_address') }}",
                            type: 'POST',
                            contentType: false,
                            processData: false,
                            cache: false,
                            timeout: 600000,
                            dataType: 'json',
                            data: data,
                            success: function (response) {

                                $('#checkout_shipping_address').empty().append(response.checkout_address);
                                $('#modal_shipping_address').modal('toggle');
                                $('.modal-backdrop').removeClass('modal-backdrop');
                                $('#modal_shipping_address').addClass('fade');
                                $('#basket_container').css({overflow: "auto"});
                                $('#address_clinic_name').val('');
                                $('#address_telephone').val('');
                                $('#address_line_1').val('');
                                $('#address_suite').val('');
                                $('#address_postal_code').val('');
                                $('#address_city').val('');
                                $('#address_state').val('');
                                $('#shipping_address_id').val(response.checkout_address_id);
                            }
                        });
                    }
                } else {

                    $.ajax({
                        async: "true",
                        url: "{{ path('get_address') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            id: address_id
                        },
                        success: function (response) {

                            $('#modal_shipping_address').modal('toggle');
                            $('#basket_container').css({overflow: "auto"});
                            $('#shipping_address_id').val(address_id);
                            $('#checkout_shipping_address').empty().append(response.address);
                        }
                    });
                }
            });
            $(document).on('submit', '#form_addresses_billing_checkout', function(e){

                e.preventDefault();

                if($('.existing-address').length == 0) {

                    let is_valid = true;
                    let clinic_name = $('#address_clinic_name').val();
                    let telephone = $('#address_telephone').val();
                    let address_line_1 = $('#address_line_1').val();
                    let type = $('#address_type').val();
                    let error_clinic_name = $('#error_address_clinic_name');
                    let error_telephone = $('#error_address_telephone');
                    let error_address_line_1 = $('#error_address_line_1');
                    let error_type = $('#error_address_type');

                    error_clinic_name.hide();
                    error_telephone.hide();
                    error_address_line_1.hide();
                    error_type.hide();

                    if(clinic_name == '' || clinic_name == 'undefined'){

                        error_clinic_name.show();
                        is_valid = false;
                    }

                    if(telephone == '' || telephone == 'undefined'){

                        error_telephone.show();
                        is_valid = false;
                    }

                    if(address_line_1 == '' || address_line_1 == 'undefined'){

                        error_address_line_1.show();
                        is_valid = false;
                    }

                    if(type == '' || type == 'undefined'){

                        error_type.show();
                        is_valid = false;
                    }

                    if (is_valid == true) {

                        $("<input />").attr("type", "hidden").attr("name", "page_id").attr("value", $('#page_no').val()).appendTo("#form_addresses");

                        let data = new FormData(this);

                        $.ajax({
                            async: "true",
                            url: "{{ path('update_address') }}",
                            type: 'POST',
                            contentType: false,
                            processData: false,
                            cache: false,
                            timeout: 600000,
                            dataType: 'json',
                            data: data,
                            beforeSend: function (){
                              isLoading(true);
                            },
                            success: function (response) {

                                $('#checkout_billing_address').empty().append(response.checkout_address);
                                $('#modal_billing_address').modal('toggle');
                                $('#basket_container').css({overflow: "auto"});
                                $('#address_clinic_name').val('');
                                $('#address_telephone').val('');
                                $('#address_mobile').val('');
                                $('#address_line_1').val('');
                                $('#billing_address_id').val(response.checkout_address_id);
                                isLoading(false);
                            }
                        });
                    }
                } else {

                    let data = new FormData(this);
                    let id = data.get('address');

                    $.ajax({
                        async: "true",
                        url: "{{ path('get_address') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            id: id
                        },
                        success: function (response) {
                            $('#modal_billing_address').modal('toggle');
                            $('#basket_container').css({overflow: "auto"});
                            $('#billing_address_id').val(id);
                            $('#checkout_billing_address').empty().append(response.address);
                        }
                    });


                }
            });
            $(document).on('click', '#link_shipping_address_modal', function (){

                $.ajax({
                    async: "true",
                    url: "/clinics/get-address-modal/2",
                    type: 'GET',
                    dataType: 'json',
                    success: function (response) {
                        $('#billing_address_modal').empty();
                        $('#shipping_address_modal').empty().append(response.modal);
                        $('#address_type').attr('readonly', true);
                        $('#option_shipping').attr('selected', true);
                        $('#modal_header_address').empty()
                            .append('<h5 class="modal-title" id="address_modal_label">Use an Existing Address</h5>')
                            .append('<span class="badge bg-success ms-3 toggle_address" role="button">Create A New Address</span>')
                            .append('<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>');
                        $('.modal-body-address-new').hide();
                        $('.modal-body-address-existing').show();

                        let input = document.querySelector("#address_mobile");

                        iti = window.intlTelInput(input, {
                            preferredCountries: ['ae','qa', 'bh', 'om', 'sa'],
                            initialCountry: response.iso_code,
                            autoPlaceholder: "polite",
                            nationalMode: true,
                            utilsScript: "{{ asset('js/utils.min.js') }}", // just for formatting/placeholders etc
                            separateDialCode: true,
                            utilsScript: "/js/utils.js",
                        });
                    }
                });
            });
            $(document).on('click', '#link_billing_address_modal', function (){

                $.ajax({
                    async: "true",
                    url: "/clinics/get-address-modal/1",
                    type: 'GET',
                    dataType: 'json',
                    success: function (response) {
                        $('#shipping_address_modal').empty();
                        $('#billing_address_modal').empty().append(response.modal);
                        $('#modal_header_address').empty()
                            .append('<h5 class="modal-title" id="address_modal_label">Use an Existing Address</h5>')
                            .append('<span class="badge bg-success ms-3 toggle_address" role="button">Create A New Address</span>')
                            .append('<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>');
                        $('.modal-body-address-new').hide();
                        $('.modal-body-address-existing').show();

                        let input = document.querySelector("#address_mobile");

                        iti = window.intlTelInput(input, {
                            preferredCountries: ['ae','qa', 'bh', 'om', 'sa'],
                            initialCountry: response.iso_code,
                            autoPlaceholder: "polite",
                            nationalMode: true,
                            utilsScript: "{{ asset('js/utils.min.js') }}", // just for formatting/placeholders etc
                            separateDialCode: true,
                            utilsScript: "/js/utils.js",
                        });
                    }
                });
            });
            $(document).on('click', '#btn_map_checkout_shipping', function (){
                let visible = $('#address_map').is(":visible");
                let width = $(window).width();
                let modal_height = $('#modal_shipping_address .modal-body').height();
                $('#address_map').toggle(700);

                if(visible == false){

                    let height = $('#modal_shipping_address .modal-body').height();
                    $.session.set('modal_height', height);

                    if(width < 579) {

                        $('#modal_shipping_address .modal-body').css('height', (modal_height + 570));

                    } else {

                        $('#modal_shipping_address .modal-body').css('height',(modal_height + 370));
                    }

                } else {

                    $('#modal_shipping_address .modal-body').css('height', $.session.get('modal_height'));
                }
            });
            $(document).on('click', '#btn_map_checkout_billing', function (){
                let visible = $('#address_map').is(":visible");
                let width = $(window).width();
                let modal_height = $('#billing_address_modal .modal-body').height();
                $('#address_map').toggle(700);

                if(visible == false){

                    let height = $('#billing_address_modal .modal-body').height();
                    $.session.set('modal_height', height);

                    if(width < 579) {

                        $('#billing_address_modal .modal-body').css('height', (modal_height + 570));

                    } else {

                        $('#billing_address_modal .modal-body').css('height',(modal_height + 370));
                    }

                } else {

                    $('#billing_address_modal .modal-body').css('height', $.session.get('modal_height'));
                }
            });
            $(document).on('click', '#btn_map', function (){

                let visible = $('#address_map').is(":visible");
                let width = $(window).width();
                let modal_height = $('#modal_address .modal-body').height();
                $('#address_map').toggle(700);

                if(visible == false){

                    let height = $('#modal_address .modal-body').height();
                    $.session.set('modal_height', height);

                    if(width < 579) {

                        $('#modal_address .modal-body').css('height', (modal_height + 370));

                    } else {

                        $('#modal_address .modal-body').css('height', (modal_height + 370));
                    }

                } else {

                    $('#modal_address .modal-body').css('height', $.session.get('modal_height'));
                }
            });
            {# End Addresses #}

            {# Communication Methods #}
            let mobile_number = '';
            iti = '';
            let input = '';
            function getCommunicationMethods(page_id){

                $('#back_btn').remove();

                $.ajax({
                    async: "true",
                    url: '{{ path('get_communication_methods') }}',
                    type: 'POST',
                    dataType: 'json',
                    data:{
                        page_id: page_id,
                        permissions: '{{ permissions|json_encode }}'
                    },
                    beforeSend: function (){

                        isLoading(true)
                    },
                    complete: function(e, xhr, settings){
                        if(e.status === 500){
                            window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                    success: function (response) {

                        getBackButton();
                        $('#inventory').hide();
                        $('#inventory_container').hide();
                        $('#basket_container').empty().removeClass('col-container').append(response.html).show();
                        $('#paginator').empty().append(response.pagination).show();
                        window.scrollTo(0,0);
                        clearInterval(get_messages);
                        isLoading(false);
                        window.history.pushState(null, "Fluid", '/clinics/communication-methods');
                    }
                });
            }
            $('#communication_methods_link').click(function (e){

                e.preventDefault();
                getCommunicationMethods();
            });
            $(document).on('click','.ccm-pagination', function (e){

                e.preventDefault();

                let page_id = $(this).data('page-id');

                getCommunicationMethods(page_id);
            });
            $(document).on('click','#communication_methods_new', function (){
                $('#col_send_to').hide();
                $('#btn_save_communication_method').empty().append('CREATE');
            });
            $(document).on('change','#communication_methods_type',function (){

                $('#error_communication_method').hide();
                $('#error_send_to').hide();

                let communication_method = $('#communication_methods_type').val();

                if(communication_method == 0 || communication_method == 1){

                    $('#col_send_to').hide();
                }

                if(communication_method == 2){

                    $('#send_to_container').empty().append('<input type="text" name="clinic_communication_methods_form[sendTo]" id="send_to" class="form-control">');
                    $('#label_send_to').empty().append('Email Address').show();
                    $('#send_to').attr('placeholder', 'Enter your email address');
                }

                if(communication_method == 3){

                    $('#send_to_container').empty().append('<input type="text" name="clinic_communication_methods_form[sendTo]" id="send_to" class="form-control">');
                    $('#label_send_to').empty().append('Mobile Phone Number').show();

                    let input = document.querySelector("#send_to");
                    iti = window.intlTelInput(input, {
                        preferredCountries: ['ae','qa', 'bh', 'om', 'sa'],
                        autoPlaceholder: "polite",
                        nationalMode: true,
                        utilsScript: "{{ asset('js/utils.min.js') }}", // just for formatting/placeholders etc
                        separateDialCode: true,
                        utilsScript: "/js/utils.js",
                    });

                    let handleChange = function() {
                        let mobile = $('#mobile_no');
                        let mobile_number = (iti.isValidNumber()) ? iti.getNumber() : false;
                        let textNode = document.createTextNode(mobile_number);

                        if(mobile_number != false){

                            mobile.val(mobile_number.substring(1));
                        }
                    };

                    // listen to "keyup", but also "change" to update when the user selects a country
                    input.addEventListener('change', handleChange);
                    input.addEventListener('keyup', handleChange);
                }

                if(communication_method == 2 || communication_method == 3) {

                    $('#col_send_to').show();
                    $('#send_to').show();
                }
            });
            $(document).on('click', '.communication_method_update', function () {

                let clinic_method_id = $(this).data('clinic-communication-method-id');
                let method_id = $(this).data('communication-method-id');
                let isoCode = '';

                if(method_id == 3){

                    $('#send_to_container').empty().append('<input type="text" name="clinic_communication_methods_form[sendTo]" id="send_to" class="form-control">');

                } else if(method_id == 2){

                    $('#send_to_container').empty().append('<input type="text" name="clinic_communication_methods_form[sendTo]" id="send_to" class="form-control" placeholder="Enter your email address">');
                }

                $.ajax({
                    async: "true",
                    url: "{{ path('get_communication_method') }}",
                    type: 'POST',
                    data: {
                        id: clinic_method_id
                    },
                    complete: function(e, xhr, settings){
                        if(e.status === 500){
                            window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                    success: function (response) {

                        isoCode = response.iso_code;

                        if(method_id == 3){

                            input = document.querySelector("#send_to");
                            iti = window.intlTelInput(input, {
                                initialCountry: isoCode,
                                preferredCountries: ['ae','qa', 'bh', 'om', 'sa'],
                                autoPlaceholder: "polite",
                                nationalMode: false,
                                utilsScript: "{{ asset('js/utils.min.js') }}", // just for formatting/placeholders etc
                                separateDialCode: true,
                                utilsScript: "/js/utils.js",
                            });

                            $('#label_send_to').empty().append('Mobile Phone Number').show();
                            $('#send_to').show();
                        }

                        $('#send_to').val(response.send_to);
                        $('#communication_methods_type option[value="'+ response.method_id +'"]').attr('selected',false);
                        $('#communication_methods_type option[value="'+ response.method_id +'"]').attr('selected','selected');
                    }
                });

                let communication_method = $(this).data('communication-method-id');

                if(communication_method == 0 || communication_method == 1){

                    $('#col_send_to').hide();
                    $('#label_send_to').hide();
                }

                if(communication_method == 2){

                    $('#label_send_to').empty().append('Email Address').show();
                    $('#send_to').attr('placeholder', 'Enter your email address').show();
                }

                if(communication_method == 2 || communication_method == 3) {

                    $('#col_send_to').show();
                }

                $('#clinic_communication_methods_form_communicationMethod_clinicCommunicationMethods option[value="'+ communication_method +'"]').attr('selected',false);
                $('#clinic_communication_methods_form_communicationMethod_clinicCommunicationMethods option[value="'+ communication_method +'"]').attr('selected','selected');
                $('#communication_method_id').val(clinic_method_id);
                $('#communication_methods_modal_label').empty().append('Update A Communication Method');
                $('#btn_save_communication_method').empty().append('UPDATE');
            });
            $(document).on('focus','#send_to', function (){

                let communication_method = $('#communication_methods_type').val()

                if(communication_method == 3){

                    input = document.querySelector("#send_to");

                    let handleChange = function() {

                        let mobile = $('#mobile_no');
                        let mobile_number = (iti.isValidNumber()) ? iti.getNumber() : false;
                        let textNode = document.createTextNode(mobile_number);

                        if(mobile_number != false){

                            mobile.val(mobile_number.substring(1));
                        }
                    };

                    // listen to "keyup", but also "change" to update when the user selects a country
                    input.addEventListener('change', handleChange);
                    input.addEventListener('keyup', handleChange);

                    $('#label_send_to').empty().append('Mobile Phone Number').show();
                    $('#send_to').show();
                }
            });
            $(document).on('click', '.method-delete', function () {

                $('#delete_method').attr('data-communication-method-id', $(this).data('clinic-communication-method-id'));
            });
            $(document).on('click', '#delete_method', function () {

                let method_id = $(this).data('communication-method-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('communication_method_delete') }}",
                    type: 'POST',
                    data: {
                        id: method_id
                    },
                    complete: function(e, xhr, settings){
                        if(e.status === 500){
                            window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                    success: function (response) {
                        $('#modal_method_delete').modal('toggle');
                        $('#modal_method_delete').modal('hide');
                        $('.modal-backdrop').removeClass('modal-backdrop');
                        $('#modal_method_delete').addClass('fade');
                        getFlash(response.flash);
                        $('#basket_container').empty().append(response.communication_methods);
                    }
                });
            });
            $(document).on('submit', '#form_communication_methods', function(e){

                e.preventDefault();

                let is_valid = true;
                let communication_method = $('#communication_methods_type').val();
                let send_to = $('#send_to').val();
                let mobile = $('#mobile_no').val();
                let error_communication_method = $('#error_communication_method');
                let error_send_to = $('#error_send_to');
                let error_mobile = $('#error_communication_method_mobile');

                error_communication_method.hide();
                error_send_to.hide()
                error_mobile.hide();

                if(communication_method == '' || communication_method == 'undefined' || communication_method == 0){

                    error_communication_method.show();
                    is_valid = false;
                }

                if((send_to == '' || send_to == 'undefined') && (communication_method == 2)){

                    error_send_to.show();
                    is_valid = false;
                }

                if(mobile == 0 && communication_method == 3){

                    error_mobile.show();
                    is_valid = false;
                }

                if(is_valid == true){

                    if(communication_method == 3) {

                        let page_id = $('#page_no').val();
                        let iso = iti.getSelectedCountryData().iso2;
                        let intlCode = iti.getSelectedCountryData().dialCode

                        $('<input />').attr('type', 'hidden').attr('name', 'page_id')
                            .attr('value', page_id).appendTo('#form_communication_methods');
                        $('<input />').attr('type', 'hidden').attr('name', 'clinic_communication_methods_form[iso_code]')
                            .attr('value', iso).appendTo('#form_communication_methods');
                        $('<input />').attr('type', 'hidden').attr('name', 'clinic_communication_methods_form[intl_code]')
                            .attr('value', intlCode).appendTo('#form_communication_methods');
                    }

                    let data = new FormData(this);

                    $.ajax({
                        async: "true",
                        url: "{{ path('manage_communication_methods') }}",
                        type: 'POST',
                        contentType: false,
                        processData: false,
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data: data,
                        beforeSend: function (){
                          isLoading(true);
                        },
                        complete: function(e, xhr, settings){
                            if(e.status === 500){
                                window.location.href = '{{ path('clinic_error_500') }}';
                            }
                        },
                        success: function (response) {
                            getFlash(response.flash);
                            $('#modal_communication_methods').modal('toggle');
                            $('#modal_communication_methods').modal('hide');
                            $('.modal-backdrop').removeClass('modal-backdrop');
                            $('.fade').removeClass('fade');
                            $('#clinic_communication_methods_form_communicationMethod_clinicCommunicationMethods').val('');
                            $('#send_to').val('');
                            $('#basket_container').empty().append(response.communication_methods);
                            $('#paginator').empty().append(response.pagination).show();
                            isLoading(false);
                        }
                    });
                }
            });
            {# End Communivation Methods #}

            {# Species #}
            $(document).on('click', '.species-checkbox', function (){

                let checkbox = $(this);

                if(checkbox.is(':checked')) {

                    checkbox.attr('checked', true);
                    $(this).next('.custom-control-label').find('.species-icon').removeClass('fa-light').addClass('fa-solid');

                } else {

                    checkbox.attr('checked', false);
                    $(this).next('.custom-control-label').find('.fa-solid').removeClass('fa-solid').addClass('fa-light');
                }
            });
            {# End Species #}

            {# Menu Drop Downs #}
            if ($(window).width() < 769){

                $('#dd_categories').hide();
                $('#dd_filters').hide();
                $('#dd_manufacturers_1').hide();
                $('#dd_manufacturers_2').hide();
                $('#dd_distributors').hide();

            } else {

                //$('#megamenu').addClass('pb-3')
            }

            let dropdowns = ''

            $('#btn_categories').click(function (e){

                e.preventDefault();
                $('#dd_categories').toggle(700,'linear');
            });
            $('#btn_filters').click(function (e){

                e.preventDefault();
                $('#dd_filters').toggle(700,'linear');
            });
            $('#btn_manufacturers').click(function (e){

                e.preventDefault();
                $('#dd_manufacturers_1').toggle(700,'linear');
                $('#dd_manufacturers_2').toggle(700,'linear');
            });
            $('#btn_distributors').click(function (e){

                e.preventDefault();
                $('#dd_distributors').toggle(700,'linear');
            });
            {# End Mebu Drop Downs #}

            function resetFilterBtn(){

                let btn_reset = '<div class="col-12" id="filter_reset_btn"><button type="button" class="btn bg-secondary btn-sm w-100 border-top">';
                btn_reset += '<i class="fa-solid fa-rotate me-1" role="button"></i>Reset Filters</button></div>';

                $('#filter_reset_btn').remove();
                $('#filter_megamenu').append(btn_reset);
            }

            {# Account Menu Toggle #}
            $(document).mouseup(function(e) {

                let container = $('#account_menu');

                // if the target of the click isn't the container nor a descendant of the container
                let displayValue = $('#account_menu').get(0).style.display;

                if(displayValue == 'block'){

                    isLoading(true);
                    container.hide(700);

                }
            });
            $(document).on('click', '.account-dropdown-toggle', function(e) {

                let container = $('#account_menu');

                // if the target of the click isn't the container nor a descendant of the container
                let displayValue = $('#account_menu').get(0).style.display;

                if(displayValue == 'block'){

                    container.hide(700);

                } else {

                    container.show(700);
                }
            });

            {# Filter Menu Toggle #}
            $(document).mouseup(function(e) {

                let container = $('#megamenu');

                // if the target of the click isn't the container nor a descendant of the container
                let displayValue = $('#megamenu').get(0).style.display;

                if(displayValue == 'block'){

                    container.slideUp(700);

                }
            });
            $(document).on('click', '.filter-dropdown-toggle', function(e) {

                let container = $('#megamenu');

                // if the target of the click isn't the container nor a descendant of the container
                let displayValue = $('#megamenu').get(0).style.display;

                if(displayValue == 'block'){

                    //container.slideUp(700);

                } else {

                    container.slideDown(700);
                }
            });

            {# Inventory #}
            function getManageInventory()
            {
                $.ajax({
                    async: "true",
                    url: "{{ path('clinics_get_inventory') }}",
                    type: 'POST',
                    dataType: 'json',
                    beforeSend: function ()
                    {
                        isLoading(true);
                    },
                    complete: function(e, xhr, settings){
                        if(e.status === 500)
                        {
                           window.location.href = '{{ path('clinic_error_500') }}';
                        }
                    },
                    success: function (response)
                    {
                        $('#basket_container').hide();
                        $('#inventory_container').show();
                        $('#inventory').empty().append(response).show();
                        window.scrollTo(0,0);
                        isLoading(false);
                        window.history.pushState(null, "Fluid", '/clinics/manage-inventory');
                        popOver();
                    }
                });
            }
            $(document).on('click', '#inventory_link', function (e)
            {
                e.preventDefault();
                getManageInventory();
            });
            $(document).on('click', '#btn_search_inventory', function (e)
            {
                e.preventDefault();

                let text = '';

                if($(this).find('i').hasClass('fa-magnifying-glass-plus'))
                {
                    text = '<i class="fa-regular fa-magnifying-glass-minus me-2 mb-3"></i> Search Inventory';
                }
                else
                if($(this).find('i').hasClass('fa-magnifying-glass-minus'))
                {
                    text = '<i class="fa-regular fa-magnifying-glass-plus me-2 mb-3"></i> Search Inventory';
                }

                $('#btn_search_inventory').empty().append(text);
                $('#btn_search_inventory').empty().append(text);
                $('#inventory_attach_container').slideToggle(700);
            });
            $(document).on('keyup','#search_inventory_field', function()
            {
                $.ajax({
                    type: "POST",
                    url: "{{ path('clinic_inventory_search_list') }}",
                    data:'keywords='+$(this).val(),
                    success: function(response)
                    {
                        $("#suggestion_field").show();
                        $("#suggestion_field").html(response);
                    }
                });
            });
            $(document).on('click', '.search-item', function ()
            {
                $('.clear-search').removeClass('hidden');
                $('.search-div').removeClass('col-12').addClass('col-11');
            });
            $(document).on('change','#distributor_id',function ()
            {
                let distributorId = $(this).val();
                let productId = $('#product_id').val();

                $.ajax({
                    type: "POST",
                    url: "{{ path('clinic_get_distributor_product') }}",
                    data:{
                        'product-id': productId,
                        'distributor-id': distributorId,
                    },
                    success: function(response)
                    {
                        $("#sku").val(response.sku);
                        $("#cost_price").val(response.price);
                    }
                });
            });
            $(document).on('click', '#btn_inventory', function (e)
            {
                e.preventDefault();

                let isValid = true;
                let productId = $('#product_id').val();
                let listId = $('#btn_inventory').attr('data-list-id');
                let productName = $('#search_inventory_field').val();
                let distributorId = $('#distributor_id').val();
                let unitPrice = $('#your_price').val();
                let errorDistributorId = $('#error_distributor_id');
                let errorUnitPrice = $('#error_your_price');
                let favourite = false;
                let retail = true;

                errorDistributorId.hide();
                errorUnitPrice.hide();

                if(distributorId == '' || distributorId == 'undefined')
                {
                    errorDistributorId.show();
                    isValid = false;
                }

                if(unitPrice == '' || unitPrice == 'undefined')
                {
                    errorUnitPrice.show();
                    isValid = false;
                }

                if(isValid)
                {
                    $.ajax({
                        url: "{{ path('inventory_manage_list') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            'product-id': productId,
                            'list-id': listId,
                            'distributor-id': distributorId,
                            'favourite': favourite,
                            'retail': retail,
                            'unit-price': unitPrice,
                            'return': 'list',
                        },
                        beforeSend: function ()
                        {
                            isLoading(true);
                        },
                        complete: function(e)
                        {
                            if(e.status === 500)
                            {
                                window.location.href = '{{ path('clinic_error_500') }}';
                            }
                        },
                        success: function (response)
                        {
                            getFlash(response.flash);
                            $('#inventory_list').empty().append(response.html);
                            $('#inventory_item').slideUp(700);
                            $('#inventory_attach_container').slideUp(700);
                            $('#search_inventory_field').val('');
                            $('.fa-magnifying-glass-minus').addClass('fa-magnifying-glass-plus').removeClass('fa-magnifying-glass-minus');
                            isLoading(false);
                            popOver();
                        }
                    });
                }
            });
            $(document).on('click', '#inventory_clear', function (e)
            {
                e.preventDefault();

                $('.form-control').val('');
                $('#product_id').val('');
            })
            $(document).on('click', '.edit-product', function (e)
            {
                e.preventDefault();

                $('#inventory_attach_container').slideDown('700');
                window.scrollTo(0, 0);
            })
            $(document).on('click', '.retail', function (e)
            {
                e.preventDefault();

                let productId = $(this).data("product-id");
                let listId = $(this).data("list-id");
                let retail = $(this).attr('data-retail');

                if(retail == 'false')
                {
                    $.ajax({
                        async: "true",
                        url: "{{ path('inventory_get_list_modal') }}",
                        type: 'POST',
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data:
                        {
                            'product-id': productId,
                            'list-id': listId,
                            'retail': true,
                        },
                        success: function (response)
                        {
                            $('#modal_list_distributors').remove();
                            $('#inventory_container').append(response);
                            $('#modal_list_distributors').modal('toggle');
                            $('#save_list_distributor').attr('data-retail','true');
                            $('body').css('overflow', '');
                        }
                    });
                }
                else
                {
                    let distributorId = $(this).data('distributor-id');

                    $.ajax({
                        async: "true",
                        url: "{{ path('inventory_manage_list') }}",
                        type: 'POST',
                        cache: false,
                        timeout: 600000,
                        dataType: 'json',
                        data:
                        {
                            'product-id': productId,
                            'list-id': listId,
                            'distributor-id': distributorId,
                            'favourite': favourite,
                            'retail': retail,
                            delete: true,
                            'return': '',
                        },
                        success: function (response)
                        {
                            $('#retail_'+ productId).removeClass('text-danger').addClass('icon-unchecked')
                                .attr('data-retail', false).removeAttr('data-distributor-id');
                        }
                    });
                }
            });
            $(document).on('click', '.delete-clinic-product', function (e)
            {
                e.preventDefault();

                let distributorId = $(this).attr('data-distributor-id');
                let productId = $(this).attr('data-clinic-product-id');
                let listId = $(this).attr('data-list-id');

                $.ajax({
                    async: "true",
                    url: "{{ path('inventory_manage_list') }}",
                    type: 'POST',
                    cache: false,
                    timeout: 600000,
                    dataType: 'json',
                    data:
                    {
                        'product-id': productId,
                        'list-id': listId,
                        'distributor-id': distributorId,
                        'favourite': false,
                        'retail': true,
                        delete: true,
                        'return': 'list',
                    },
                    beforeSend: function ()
                    {
                        isLoading(true);
                    },
                    success: function (response)
                    {
                        $('#clinic_product_'+ productId).remove();
                        $('#inventory_list').empty().append(response.html);
                        isLoading(false);
                        popOver();
                    }
                });
            });
            $(document).on('change', '#manufacturer_id, #species_id', function ()
            {
                let manufacturerId = $('#manufacturer_id').val() ? $('#manufacturer_id').val() : 0;
                let speciesId = $('#species_id').val() ? $('#species_id').val() : 0;

                if(manufacturerId > 0 || speciesId > 0)
                {
                    $.ajax({
                        url: "{{ path('clinic_filter_list') }}",
                        type: 'POST',
                        dataType: 'json',
                        data: {
                            'manufacturer-id': manufacturerId,
                            'species-id': speciesId,
                        },
                        beforeSend: function () {

                            isLoading(true);
                        },
                        success: function (response) {

                            $('#inventory_list').empty().append(response);
                            $('#filter_reset').show();
                            isLoading(false);
                            popOver();
                        }
                    });
                }
            });
            $(document).on('click', '#filter_reset', function (e)
            {
                e.preventDefault();

                getManageInventory();
                $(this).hide();
            });
        });

        function selectProductListItem(id, name)
        {
            if (id > 0) {

                $.ajax({
                    type: "POST",
                    url: "{{ path('clinic_inventory_get_data') }}",
                    data: {
                        'product-id': id,
                    },
                    success: function (response)
                    {
                        $("#suggestion_field").show();
                        $("#suggestion_field").html(response);
                        $('#product_id').val(id);
                        $('#distributor_id').empty().append(response.distributors);
                        $('option[value="'+ response.distributorId +'"]').prop("selected", true);
                        $('#unit').val(response.unit);
                        $('#sku').val(response.sku);
                        $('#cost_price').val(response.costPrice);
                        $('#your_price').val(response.unitPrice);
                        $('#dosage').val(response.dosage);
                        $('#size').val(response.size);
                        $('#active_ingredient').val(response.activeIngredient);
                        $('#product_name').empty();
                        $('#product_name').append(name + response.dosage + response.unit + response.size);
                        $('#inventory_item').slideDown(700);
                    }
                });

                $("#search_inventory_field").val(name);
                $("#suggestion_field").hide();
            }
        }

        function getProductDistributors(productId, listId)
        {
            if (productId > 0)
            {
                $.ajax({
                    async: "true",
                    url: "{{ path('inventory_get_list_modal') }}",
                    type: 'POST',
                    cache: false,
                    timeout: 600000,
                    dataType: 'json',
                    data: {
                        'product-id': productId,
                        'list-id': listId

                    },
                    success: function (response)
                    {
                        $('#modal_list_distributors').remove();
                        $('#basket_container').append(response);
                        $('#modal_list_distributors').modal('toggle');
                        //$('#save_list_distributor').attr('data-favourite','false');
                        $('body').css('overflow', '');
                    }
                });

                $("#search_inventory_field").val(name);
                $("#suggestion_field").hide();
            }
        }

        {# Popovers #}
        function popOver() {
            var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'))
            var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
                return new bootstrap.Popover(popoverTriggerEl)
            })
        }

        {# Hide Paginator #}
        function hidePaginator(){

            $('#paginator').empty().hide();
        }

        {# Clode Flash Message #}
        $('#flash').click(function (){
            $('#flash').addClass('hidden');
        });
    </script>
{% endblock %}